<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pocket Money Manager - Enhanced</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-primary: #f3f4f6;
      --bg-card: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #4b5563;
      --text-header: #111827;
      --border-color: #d1d5db;
      --accent-color: #4f46e5;
      --accent-hover: #4338ca;
      --income-color: #22c55e;
      --expense-color: #ef4444;
    }

    [data-theme="dark"] {
      --bg-primary: #111827;
      --bg-card: #1f2937;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --text-header: #ffffff;
      --border-color: #4b5563;
    }

    [data-theme="mint"] {
      --bg-primary: #f0fdfa;
      --bg-card: #ffffff;
      --text-primary: #134e4a;
      --text-secondary: #115e59;
      --text-header: #0f766e;
      --border-color: #ccfbf1;
      --accent-color: #14b8a6;
      --accent-hover: #0d9488;
      --income-color: #16a34a;
      --expense-color: #dc2626;
    }

    [data-theme="sunset"] {
      --bg-primary: #fffbeb;
      --bg-card: #ffffff;
      --text-primary: #78350f;
      --text-secondary: #92400e;
      --text-header: #b45309;
      --border-color: #fef3c7;
      --accent-color: #f59e0b;
      --accent-hover: #d97706;
      --income-color: #16a34a;
      --expense-color: #dc2626;
    }

    [data-theme="dynamic"] {
      --bg-primary: linear-gradient(-45deg, #667eea, #764ba2, #23a6d5, #23d5ab);
      --bg-card: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: #e5e7eb;
      --text-header: #ffffff;
      --border-color: rgba(255, 255, 255, 0.2);
      --accent-color: #38bdf8;
      --accent-hover: #0ea5e9;
      --income-color: #4ade80;
      --expense-color: #f87171;
    }

    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    body {
      font-family: "Inter", sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background 2s, color 0.3s;
      min-height: 100vh;
      margin: 0;
    }

    body[data-theme="dynamic"] {
      background-size: 400% 400%;
      animation: gradientAnimation 15s ease infinite;
    }

    .card {
      background-color: var(--bg-card);
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease-in-out;
      padding: 1.5rem;
    }

    .btn-primary {
      background-color: var(--accent-color);
      color: white;
      transition: background-color 0.3s ease;
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      width: 100%;
    }

    .btn-primary:hover,
    .btn-primary:focus {
      background-color: var(--accent-hover);
      outline: none;
    }

    .btn-secondary {
      background-color: var(--border-color);
      color: var(--text-primary);
      transition: opacity 0.3s ease;
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      width: 100%;
    }

    .btn-secondary:hover,
    .btn-secondary:focus {
      opacity: 0.9;
      outline: none;
    }

    .btn-danger {
      background-color: var(--expense-color);
      color: white;
      transition: background-color 0.3s ease;
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      width: 100%;
    }

    .btn-danger:hover,
    .btn-danger:focus {
      background-color: #dc2626;
      outline: none;
    }

    .form-input {
      border-radius: 0.5rem;
      border: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      width: 100%;
      background-color: var(--bg-card);
      color: var(--text-primary);
      transition: border-color 0.3s;
      font-size: 1rem;
    }

    .form-input:focus {
      border-color: var(--accent-color);
      outline: none;
      box-shadow: 0 0 3px var(--accent-color);
    }

    .transaction-item {
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      padding: 1rem;
      cursor: default;
      user-select: none;
      transition: background-color 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .transaction-item:hover,
    .transaction-item:focus-within {
      background-color: var(--bg-primary);
      outline: none;
    }

    .transaction-item.selected {
      border-color: var(--accent-color);
      background-color: rgba(79, 70, 229, 0.1);
    }

    .text-green { color: var(--income-color); }
    .text-red { color: var(--expense-color); }
    .text-gray-600 { color: var(--text-secondary); }
    .text-gray-900 { color: var(--text-header); }
    .text-indigo-600 { color: var(--accent-color); }

    .error-msg {
      color: var(--expense-color);
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    .progress-bar {
      height: 1rem;
      border-radius: 0.5rem;
      background-color: #e5e7eb;
      width: 100%;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 0.5rem 0 0 0.5rem;
      background-color: var(--accent-color);
      transition: width 0.3s ease-in-out;
    }

    .alert {
      margin-top: 0.25rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--expense-color);
    }

    .quick-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .quick-buttons button {
      width: auto;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    /* New Task Menu Styles */
    .new-task-menu {
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 0.5rem;
      width: 200px;
      z-index: 50;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .new-task-menu button {
      width: 100%;
      text-align: left;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .new-task-menu button:last-child {
      margin-bottom: 0;
    }

    .refresh-icon-btn {
      width: auto;
      padding: 0.5rem 0.75rem;
      font-size: 1.2rem;
    }

    /* Multiple delete controls */
    .multiple-delete-controls {
      background-color: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      display: none;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .multiple-delete-controls.active {
      display: flex;
    }

    .selection-info {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .delete-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .delete-actions button {
      width: auto;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    /* Checkbox styling */
    .transaction-checkbox {
      width: 1.25rem;
      height: 1.25rem;
      margin-right: 0.75rem;
      accent-color: var(--accent-color);
    }

    .select-all-checkbox {
      width: 1.25rem;
      height: 1.25rem;
      accent-color: var(--accent-color);
    }
  </style>
</head>

<body data-theme="light">

  <div class="container mx-auto p-4 md:p-8 max-w-6xl">
    <header class="text-center mb-8 relative">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Pocket Money Manager - Enhanced</h1>
      <p class="text-gray-600 mt-2">Track your income, expenses, budgets, and recurring payments easily.</p>
      
      <!-- Theme Switcher and New Task Menu -->
      <div class="absolute top-0 right-0 flex items-center gap-2">
        <label for="theme-switcher" class="sr-only">Select Theme</label>
        <select id="theme-switcher" class="form-input p-2 rounded-md" style="width: auto;">
          <option value="light">Light ‚òÄÔ∏è</option>
          <option value="dark">Dark üåô</option>
          <option value="mint">Mint üåø</option>
          <option value="sunset">Sunset üåÖ</option>
          <option value="dynamic">Dynamic üåå</option>
        </select>

        <!-- Quick Refresh Icon Button -->
        <button id="refresh-icon-btn" title="Quick Refresh (R)" class="btn-secondary refresh-icon-btn">‚Üª</button>

        <!-- New Task Dropdown Menu -->
        <div class="relative">
          <button id="new-task-btn" class="btn-secondary px-3" aria-haspopup="true" aria-expanded="false">
            New Task ‚ñæ
          </button>
          <div id="new-task-menu" class="new-task-menu card p-3 hidden">
            <button id="soft-reset-btn" class="btn-secondary">üîÑ Soft Reset UI</button>
            <button id="hard-refresh-btn" class="btn-secondary">‚ü≥ Hard Refresh Page</button>
            <button id="clear-all-btn" class="btn-primary">üóëÔ∏è Clear All Data + Refresh</button>
          </div>
        </div>
      </div>

      <!-- Keyboard Shortcuts Info -->
      <div class="text-xs text-gray-500 mt-2">
        Keyboard shortcuts: <kbd>R</kbd> = Soft Reset, <kbd>Shift+R</kbd> = Hard Refresh, <kbd>Del</kbd> = Delete Selected
      </div>
    </header>

    <!-- Summary section -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="card flex flex-col items-center justify-center">
        <h2 class="text-lg font-semibold text-gray-600">Total Balance</h2>
        <p id="balance" class="text-3xl font-bold text-indigo-600 mt-2">‚Çπ0.00</p>
      </div>
      <div class="card flex flex-col items-center justify-center">
        <h2 class="text-lg font-semibold text-gray-600">Total Income</h2>
        <p id="income" class="text-3xl font-bold text-green mt-2">‚Çπ0.00</p>
      </div>
      <div class="card flex flex-col items-center justify-center">
        <h2 class="text-lg font-semibold text-gray-600">Total Expense</h2>
        <p id="expense" class="text-3xl font-bold text-red mt-2">‚Çπ0.00</p>
      </div>
      <div class="card">
        <h2 class="text-lg font-semibold mb-2 text-gray-700">Budget Goals</h2>
        <div id="budget-container">
          <!-- Budgets will be inserted here -->
        </div>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Form and Quick Actions -->
      <section>
        <div class="card">
          <h2 id="form-title" class="text-2xl font-bold mb-4 text-gray-900">Add / Edit Transaction</h2>

          <!-- Quick Action Buttons -->
          <div class="quick-buttons">
            <button type="button" data-desc="Salary" data-amount="50000" data-type="income" class="btn-primary">Add Salary</button>
            <button type="button" data-desc="Food" data-amount="500" data-type="expense" data-category="Food" class="btn-primary">Add Food</button>
            <button type="button" data-desc="Travel" data-amount="1000" data-type="expense" data-category="Travel" class="btn-primary">Add Travel</button>
            <button type="button" data-desc="Entertainment" data-amount="700" data-type="expense" data-category="Entertainment" class="btn-primary">Add Fun</button>
          </div>

          <form id="transaction-form" novalidate>
            <input type="hidden" id="transaction-id" />
            
            <div class="mb-4">
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <input type="text" id="description" class="form-input" placeholder="e.g., Monthly Allowance" required />
              <p id="desc-error" class="error-msg" hidden></p>
            </div>

            <div class="mb-4">
              <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
              <input type="number" id="amount" class="form-input" placeholder="Enter amount" min="0.01" step="0.01" required />
              <p id="amount-error" class="error-msg" hidden></p>
            </div>

            <div class="mb-4">
              <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input type="date" id="date" class="form-input" required />
              <p id="date-error" class="error-msg" hidden></p>
            </div>

            <div class="mb-4">
              <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
              <select id="type" class="form-input" required>
                <option value="income">Income</option>
                <option value="expense">Expense</option>
              </select>
            </div>

            <div class="mb-4" id="category-wrapper">
              <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <select id="category" class="form-input">
                <option value="Food">Food</option>
                <option value="Travel">Travel</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Bills">Bills</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="mb-4">
              <label for="recurring" class="block text-sm font-medium text-gray-700 mb-1">Recurring</label>
              <select id="recurring" class="form-input">
                <option value="none">None</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>

            <div class="flex space-x-4 mb-4">
              <button type="submit" id="submit-btn" class="btn-primary">Add Transaction</button>
              <button type="button" id="cancel-edit-btn" class="btn-secondary hidden">Cancel</button>
            </div>
          </form>

          <button id="export-btn" class="btn-secondary">Export Transactions CSV</button>
        </div>
      </section>

      <!-- Chart and History -->
      <section class="space-y-8">
        <!-- Chart -->
        <div class="card">
          <h2 class="text-2xl font-bold mb-4 text-gray-900">Expense Breakdown</h2>
          <div style="height: 300px; position: relative;">
            <canvas id="expense-chart"></canvas>
          </div>
        </div>

        <!-- Filters and Transaction History -->
        <div class="card">
          <h2 class="text-2xl font-bold mb-4 text-gray-900">Transaction History</h2>
          
          <!-- Filters -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label for="filter-date" class="block mb-2 font-medium text-gray-700">Filter by Date</label>
              <select id="filter-date" class="form-input">
                <option value="all">All Time</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
              </select>
            </div>

            <div>
              <label for="filter-category" class="block mb-2 font-medium text-gray-700">Filter by Category</label>
              <select id="filter-category" class="form-input">
                <option value="all">All Categories</option>
                <option value="income">Income</option>
                <option value="Food">Food</option>
                <option value="Travel">Travel</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Bills">Bills</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div>
              <label for="search-input" class="block mb-2 font-medium text-gray-700">Search Description</label>
              <input id="search-input" type="search" class="form-input" placeholder="Search transactions..." />
            </div>
          </div>

          <!-- Multiple Delete Controls -->
          <div id="multiple-delete-controls" class="multiple-delete-controls">
            <div class="selection-info">
              <span id="selected-count">0</span> transactions selected
            </div>
            <div class="delete-actions">
              <button id="select-all-btn" class="btn-secondary">Select All</button>
              <button id="deselect-all-btn" class="btn-secondary">Deselect All</button>
              <button id="delete-selected-btn" class="btn-danger">Delete Selected</button>
            </div>
          </div>

          <!-- Select All Checkbox -->
          <div class="flex items-center mb-3">
            <input type="checkbox" id="select-all-checkbox" class="select-all-checkbox" />
            <label for="select-all-checkbox" class="ml-2 text-sm font-medium text-gray-700">Select All Transactions</label>
          </div>

          <!-- Transaction List -->
          <ul id="transaction-list" class="space-y-3">
            <li id="no-transactions" class="text-center text-gray-600 py-4">No transactions yet.</li>
          </ul>
        </div>
      </section>
    </div>
  </div>

  <script>
    (() => {
      "use strict";

      // Number formatting for large amounts
      function formatAmount(value) {
        const absValue = Math.abs(value);
        if (absValue >= 1e12) return (value / 1e12).toFixed(2) + "T";
        if (absValue >= 1e9) return (value / 1e9).toFixed(2) + "B";
        if (absValue >= 1e6) return (value / 1e6).toFixed(2) + "M";
        if (absValue >= 1e3) return (value / 1e3).toFixed(2) + "K";
        return value.toFixed(2);
      }

      // Elements
      const balanceEl = document.getElementById("balance");
      const incomeEl = document.getElementById("income");
      const expenseEl = document.getElementById("expense");
      const transactionListEl = document.getElementById("transaction-list");
      const form = document.getElementById("transaction-form");
      const formTitle = document.getElementById("form-title");
      const descriptionInput = document.getElementById("description");
      const amountInput = document.getElementById("amount");
      const dateInput = document.getElementById("date");
      const typeInput = document.getElementById("type");
      const categoryWrapper = document.getElementById("category-wrapper");
      const categoryInput = document.getElementById("category");
      const transactionIdInput = document.getElementById("transaction-id");
      const recurringInput = document.getElementById("recurring");
      const submitBtn = document.getElementById("submit-btn");
      const cancelEditBtn = document.getElementById("cancel-edit-btn");
      const filterCategoryEl = document.getElementById("filter-category");
      const filterDateEl = document.getElementById("filter-date");
      const searchInput = document.getElementById("search-input");
      const noTransactionsEl = document.getElementById("no-transactions");
      const exportBtn = document.getElementById("export-btn");
      const budgetContainer = document.getElementById("budget-container");
      const chartCanvas = document.getElementById("expense-chart");
      const themeSwitcher = document.getElementById("theme-switcher");
      const quickButtons = document.querySelectorAll(".quick-buttons button");

      // Multiple delete elements
      const multipleDeleteControls = document.getElementById("multiple-delete-controls");
      const selectedCountEl = document.getElementById("selected-count");
      const selectAllBtn = document.getElementById("select-all-btn");
      const deselectAllBtn = document.getElementById("deselect-all-btn");
      const deleteSelectedBtn = document.getElementById("delete-selected-btn");
      const selectAllCheckbox = document.getElementById("select-all-checkbox");

      // Error elements
      const descError = document.getElementById("desc-error");
      const amountError = document.getElementById("amount-error");
      const dateError = document.getElementById("date-error");

      let expenseChart;
      let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
      let budgets = JSON.parse(localStorage.getItem("budgets")) || {
        Food: 3000,
        Travel: 2000,
        Entertainment: 1000,
        Bills: 5000,
        Other: 1000,
      };

      // Track selected transactions
      let selectedTransactions = new Set();

      // Set default date to today
      dateInput.valueAsDate = new Date();
      dateInput.max = new Date().toISOString().split("T")[0];

      // Utility functions
      const generateID = () => "_" + Math.random().toString(36).substr(2, 9);
      const saveTransactions = () => localStorage.setItem("transactions", JSON.stringify(transactions));
      const saveBudgets = () => localStorage.setItem("budgets", JSON.stringify(budgets));

      const clearValidationErrors = () => {
        [descError, amountError, dateError].forEach(el => {
          el.hidden = true;
          el.textContent = "";
        });
      };

      // MULTIPLE DELETE FUNCTIONS

      // Update selected count and controls visibility
      function updateMultipleDeleteControls() {
        const count = selectedTransactions.size;
        selectedCountEl.textContent = count;
        
        if (count > 0) {
          multipleDeleteControls.classList.add("active");
        } else {
          multipleDeleteControls.classList.remove("active");
        }

        // Update select all checkbox state
        const currentTransactions = getFilteredTransactions();
        const allSelected = currentTransactions.length > 0 && 
          currentTransactions.every(t => selectedTransactions.has(t.id));
        const someSelected = currentTransactions.some(t => selectedTransactions.has(t.id));
        
        selectAllCheckbox.checked = allSelected;
        selectAllCheckbox.indeterminate = someSelected && !allSelected;
      }

      // Handle individual transaction selection
      function toggleTransactionSelection(transactionId, isSelected) {
        if (isSelected) {
          selectedTransactions.add(transactionId);
        } else {
          selectedTransactions.delete(transactionId);
        }
        updateMultipleDeleteControls();
        updateTransactionItemStyles();
      }

      // Select all visible transactions
      function selectAllTransactions() {
        const currentTransactions = getFilteredTransactions();
        currentTransactions.forEach(t => selectedTransactions.add(t.id));
        updateMultipleDeleteControls();
        updateTransactionItemStyles();
      }

      // Deselect all transactions
      function deselectAllTransactions() {
        selectedTransactions.clear();
        updateMultipleDeleteControls();
        updateTransactionItemStyles();
      }

      // Delete selected transactions
      function deleteSelectedTransactions() {
        if (selectedTransactions.size === 0) return;
        
        const count = selectedTransactions.size;
        if (!confirm(`Are you sure you want to delete ${count} selected transaction${count > 1 ? 's' : ''}?`)) return;
        
        transactions = transactions.filter(t => !selectedTransactions.has(t.id));
        selectedTransactions.clear();
        updateMultipleDeleteControls();
        updateUI();
        showMessage(`${count} transaction${count > 1 ? 's' : ''} deleted successfully!`, "success");
      }

      // Update visual styles for selected items
      function updateTransactionItemStyles() {
        const items = document.querySelectorAll('.transaction-item');
        items.forEach(item => {
          const checkbox = item.querySelector('.transaction-checkbox');
          if (checkbox) {
            if (selectedTransactions.has(checkbox.dataset.id)) {
              item.classList.add('selected');
              checkbox.checked = true;
            } else {
              item.classList.remove('selected');
              checkbox.checked = false;
            }
          }
        });
      }

      // Setup multiple delete event listeners
      function setupMultipleDeleteEvents() {
        selectAllBtn.addEventListener("click", selectAllTransactions);
        deselectAllBtn.addEventListener("click", deselectAllTransactions);
        deleteSelectedBtn.addEventListener("click", deleteSelectedTransactions);
        
        selectAllCheckbox.addEventListener("change", (e) => {
          if (e.target.checked) {
            selectAllTransactions();
          } else {
            deselectAllTransactions();
          }
        });
      }

      // NEW TASK / REFRESH FUNCTIONS
      
      // Soft reset without losing saved transactions
      function softResetUI() {
        // Clear form
        form.reset();
        transactionIdInput.value = "";
        formTitle.textContent = "Add / Edit Transaction";
        submitBtn.textContent = "Add Transaction";
        cancelEditBtn.classList.add("hidden");
        dateInput.valueAsDate = new Date();
        clearValidationErrors();
        
        // Reset filters
        filterCategoryEl.value = "all";
        filterDateEl.value = "all";
        searchInput.value = "";
        
        // Reset type/category visibility
        typeInput.value = "income";
        toggleCategory();
        
        // Clear selections
        deselectAllTransactions();
        
        // Re-render from saved data
        updateUI();
        
        // Show success message
        showMessage("UI reset successfully! Form and filters cleared.", "success");
      }

      // Hard refresh the page
      function hardRefresh() {
        location.reload();
      }

      // Clear all app data and hard refresh
      function clearAllDataAndRefresh() {
        if (!confirm("‚ö†Ô∏è This will delete ALL saved transactions, budgets and settings permanently. Continue?")) return;
        localStorage.removeItem("transactions");
        localStorage.removeItem("budgets");
        localStorage.removeItem("theme");
        showMessage("All data cleared! Refreshing...", "success");
        setTimeout(hardRefresh, 1000);
      }

      // Simple dropdown toggler for New Task menu
      function setupNewTaskMenu() {
        const btn = document.getElementById("new-task-btn");
        const menu = document.getElementById("new-task-menu");
        
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const isOpen = !menu.classList.contains("hidden");
          menu.classList.toggle("hidden", isOpen);
          btn.setAttribute("aria-expanded", (!isOpen).toString());
        });

        // Close when clicking outside
        document.addEventListener("click", (e) => {
          if (!menu.contains(e.target) && e.target !== btn) {
            menu.classList.add("hidden");
            btn.setAttribute("aria-expanded", "false");
          }
        });

        // Menu item event listeners
        document.getElementById("soft-reset-btn").addEventListener("click", () => {
          menu.classList.add("hidden");
          btn.setAttribute("aria-expanded", "false");
          softResetUI();
        });

        document.getElementById("hard-refresh-btn").addEventListener("click", () => {
          menu.classList.add("hidden");
          btn.setAttribute("aria-expanded", "false");
          hardRefresh();
        });

        document.getElementById("clear-all-btn").addEventListener("click", () => {
          menu.classList.add("hidden");
          btn.setAttribute("aria-expanded", "false");
          clearAllDataAndRefresh();
        });
      }

      // Quick refresh icon button
      function setupQuickRefreshBtn() {
        document.getElementById("refresh-icon-btn").addEventListener("click", softResetUI);
      }

      // Keyboard shortcuts: R = soft reset, Shift+R = hard refresh, Del = delete selected
      function setupRefreshShortcuts() {
        document.addEventListener("keydown", (e) => {
          // Only trigger if not typing in input fields
          if (e.target.matches("input, textarea, select")) return;
          
          if (e.key.toLowerCase() === "r") {
            e.preventDefault();
            if (e.shiftKey) {
              hardRefresh();
            } else {
              softResetUI();
            }
          } else if (e.key === "Delete" || e.key === "Del") {
            e.preventDefault();
            deleteSelectedTransactions();
          }
        });
      }

      // Show temporary message to user
      function showMessage(text, type = "info") {
        const messageEl = document.createElement("div");
        messageEl.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-all duration-300 ${
          type === "success" ? "bg-green-500" : type === "error" ? "bg-red-500" : "bg-blue-500"
        }`;
        messageEl.textContent = text;
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
          messageEl.classList.add("opacity-0", "translate-x-full");
          setTimeout(() => document.body.removeChild(messageEl), 300);
        }, 2000);
      }

      // Date utility functions
      const isInCurrentWeek = dateStr => {
        const date = new Date(dateStr);
        const now = new Date();
        const dayOfWeek = now.getDay();
        const firstDay = new Date(now);
        firstDay.setDate(now.getDate() - dayOfWeek);
        firstDay.setHours(0, 0, 0, 0);
        return date >= firstDay && date <= now;
      };

      const isInCurrentMonth = dateStr => {
        const date = new Date(dateStr);
        const now = new Date();
        return date.getFullYear() === now.getFullYear() && date.getMonth() === now.getMonth();
      };

      // Form validation
      function validateForm() {
        clearValidationErrors();
        let valid = true;

        if (descriptionInput.value.trim() === "") {
          descError.textContent = "Description cannot be empty.";
          descError.hidden = false;
          valid = false;
        }

        const amountVal = parseFloat(amountInput.value);
        if (isNaN(amountVal) || amountVal < 0.01) {
          amountError.textContent = "Amount must be at least 0.01.";
          amountError.hidden = false;
          valid = false;
        }

        if (!dateInput.value) {
          dateError.textContent = "Date is required.";
          dateError.hidden = false;
          valid = false;
        } else if (new Date(dateInput.value) > new Date()) {
          dateError.textContent = "Date cannot be in the future.";
          dateError.hidden = false;
          valid = false;
        }

        return valid;
      }

      // Theme functions
      function applyTheme(theme) {
        document.body.dataset.theme = theme;
        localStorage.setItem("theme", theme);
        themeSwitcher.value = theme;
        updateChart();
      }

      function loadTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        applyTheme(savedTheme);
      }

      // Handle recurring transactions
      function handleRecurring() {
        const now = new Date();
        const nextTransactions = [];

        transactions.forEach(t => {
          if (t.recurring && t.recurring !== "none") {
            const lastDate = new Date(t.date);
            let nextDate = new Date(lastDate);

            // Calculate next expected date
            switch (t.recurring) {
              case "daily":
                nextDate.setDate(lastDate.getDate() + 1);
                break;
              case "weekly":
                nextDate.setDate(lastDate.getDate() + 7);
                break;
              case "monthly":
                nextDate.setMonth(lastDate.getMonth() + 1);
                break;
            }

            // Add new recurring transactions up to current date
            while (nextDate <= now) {
              const exists = transactions.some(
                tx => tx.description === t.description && tx.type === t.type && tx.date === nextDate.toISOString().slice(0, 10)
              );
              
              if (!exists) {
                nextTransactions.push({
                  ...t,
                  id: generateID(),
                  date: nextDate.toISOString().slice(0, 10),
                });
              }

              switch (t.recurring) {
                case "daily":
                  nextDate.setDate(nextDate.getDate() + 1);
                  break;
                case "weekly":
                  nextDate.setDate(nextDate.getDate() + 7);
                  break;
                case "monthly":
                  nextDate.setMonth(nextDate.getMonth() + 1);
                  break;
              }
            }
          }
        });

        if (nextTransactions.length > 0) {
          transactions = transactions.concat(nextTransactions);
          saveTransactions();
        }
      }

      // Update budget UI
      function updateBudgetUI() {
        budgetContainer.innerHTML = "";
        const expenseTotals = transactions.reduce((acc, t) => {
          if (t.type === "expense") acc[t.category] = (acc[t.category] || 0) + Math.abs(t.amount);
          return acc;
        }, {});

        for (const category in budgets) {
          const spent = expenseTotals[category] || 0;
          const goal = budgets[category];
          const progressPercent = Math.min(100, (spent / goal) * 100);

          const budgetDiv = document.createElement("div");
          budgetDiv.className = "mb-3";
          budgetDiv.innerHTML = `
            <div class="flex justify-between mb-1 text-sm">
              <span class="font-medium">${category}</span>
              <span>‚Çπ${formatAmount(spent)} / ‚Çπ${formatAmount(goal)}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progressPercent}%; background-color: ${
            progressPercent >= 100 ? 'var(--expense-color)' : 'var(--accent-color)'
          };"></div>
            </div>
            ${progressPercent >= 100 ? '<div class="alert text-xs">Budget exceeded!</div>' : ''}
          `;
          budgetContainer.appendChild(budgetDiv);
        }
      }

      // Update summary
      function updateSummary() {
        const amounts = transactions.map(t => t.amount);
        const total = amounts.reduce((acc, i) => acc + i, 0);
        const income = amounts.filter(a => a > 0).reduce((acc, i) => acc + i, 0);
        const expense = amounts.filter(a => a < 0).reduce((acc, i) => acc + i, 0) * -1;

        balanceEl.textContent = `‚Çπ${formatAmount(total)}`;
        incomeEl.textContent = `‚Çπ${formatAmount(income)}`;
        expenseEl.textContent = `‚Çπ${formatAmount(expense)}`;
      }

      // Render transactions
      function renderTransactions(list = transactions) {
        transactionListEl.innerHTML = "";
        
        if (list.length === 0) {
          transactionListEl.appendChild(noTransactionsEl);
          noTransactionsEl.style.display = "block";
          return;
        }

        noTransactionsEl.style.display = "none";

        const sorted = list.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
        sorted.forEach(t => {
          const sign = t.type === "income" ? "+" : "-";
          const li = document.createElement("li");
          li.className = "transaction-item";
          li.innerHTML = `
            <div class="flex items-center flex-1">
              <input type="checkbox" class="transaction-checkbox" data-id="${t.id}" />
              <div class="flex-1">
                <p class="font-semibold text-gray-900">${t.description}</p>
                <p class="text-sm text-gray-600">
                  ${t.type === "expense" ? t.category + ", " : ""}
                  <time datetime="${t.date}" title="${t.date}">
                    ${new Date(t.date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })}
                  </time>
                  ${t.recurring && t.recurring !== "none" ? ` ‚Ä¢ Recurring: ${t.recurring}` : ''}
                </p>
              </div>
            </div>
            <div class="text-right">
              <p class="${t.type === "income" ? "text-green" : "text-red"} font-bold">
                ${sign}‚Çπ${formatAmount(Math.abs(t.amount))}
              </p>
              <div class="flex space-x-2 mt-1">
                <button data-action="edit" data-id="${t.id}" class="text-xs text-indigo-600 hover:underline">Edit</button>
                <button data-action="delete" data-id="${t.id}" class="text-xs text-red-600 hover:underline">Delete</button>
              </div>
            </div>
          `;
          transactionListEl.appendChild(li);
        });

        // Add event listeners for checkboxes
        document.querySelectorAll('.transaction-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            toggleTransactionSelection(e.target.dataset.id, e.target.checked);
          });
        });

        // Update visual states
        updateTransactionItemStyles();
        updateMultipleDeleteControls();
      }

      // Get filtered transactions
      function getFilteredTransactions() {
        let filtered = transactions;

        // Filter by date range
        const dateFilter = filterDateEl.value;
        if (dateFilter === "week") {
          filtered = filtered.filter(t => isInCurrentWeek(t.date));
        } else if (dateFilter === "month") {
          filtered = filtered.filter(t => isInCurrentMonth(t.date));
        }

        // Filter by category
        const categoryFilter = filterCategoryEl.value;
        if (categoryFilter !== "all") {
          if (categoryFilter === "income") {
            filtered = filtered.filter(t => t.type === "income");
          } else {
            filtered = filtered.filter(t => t.type === "expense" && t.category === categoryFilter);
          }
        }

        // Filter by search term
        const searchTerm = searchInput.value.trim().toLowerCase();
        if (searchTerm) {
          filtered = filtered.filter(t => t.description.toLowerCase().includes(searchTerm));
        }

        return filtered;
      }

      // Filter and render
      function filterAndRender() {
        // Clear selections when filters change
        deselectAllTransactions();
        renderTransactions(getFilteredTransactions());
      }

      // Update chart
      function updateChart() {
        const currentTheme = localStorage.getItem("theme") || "light";

        const chartThemes = {
          light: { borderColor: "#fff", legendColor: "#6b7280", bgColors: ["#ef4444", "#f97316", "#eab308", "#84cc16", "#22c55e", "#10b981", "#14b8a6"] },
          dark: { borderColor: "#1f2937", legendColor: "#9ca3af", bgColors: ["#ef4444", "#f97316", "#eab308", "#84cc16", "#22c55e", "#10b981", "#14b8a6"] },
          mint: { borderColor: "#fff", legendColor: "#115e59", bgColors: ["#f87171", "#fb923c", "#facc15", "#a3e635", "#4ade80", "#2dd4bf", "#0d9488"] },
          sunset: { borderColor: "#fff", legendColor: "#92400e", bgColors: ["#ef4444", "#f97316", "#d97706", "#84cc16", "#22c55e", "#059669", "#0d9488"] },
          dynamic: { borderColor: "rgba(0,0,0,0.2)", legendColor: "#e5e7eb", bgColors: ["#fb7185", "#f59e0b", "#eab308", "#84cc16", "#22c55e", "#14b8a6", "#6366f1"] },
        };

        const theme = chartThemes[currentTheme] || chartThemes.light;

        const expenseTransactions = transactions.filter(t => t.type === "expense");
        const categoryTotals = expenseTransactions.reduce((acc, t) => {
          acc[t.category] = (acc[t.category] || 0) + Math.abs(t.amount);
          return acc;
        }, {});

        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);

        if (expenseChart) expenseChart.destroy();

        if (labels.length) {
          expenseChart = new Chart(chartCanvas, {
            type: "pie",
            data: {
              labels: labels,
              datasets: [{
                label: "Expense by Category",
                data: data,
                backgroundColor: theme.bgColors,
                borderColor: theme.borderColor,
                borderWidth: 2,
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: "bottom", labels: { color: theme.legendColor } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ‚Çπ${formatAmount(ctx.parsed)}` } },
              },
            },
          });
        } else {
          const ctx = chartCanvas.getContext("2d");
          ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillStyle = theme.legendColor;
          ctx.font = "16px Inter";
          ctx.fillText("No expense data to display", chartCanvas.width / 2, chartCanvas.height / 2);
        }
      }

      // Export to CSV
      function exportTransactionsCSV() {
        if (!transactions.length) {
          alert("No transactions to export.");
          return;
        }
        
        const headers = ["Description", "Amount", "Type", "Category", "Date", "Recurring"];
        const rows = transactions.map(t => [
          `"${t.description.replace(/"/g, '""')}"`,
          t.amount.toFixed(2),
          t.type,
          t.category ? `"${t.category.replace(/"/g, '""')}"` : "",
          t.date || "",
          t.recurring || "none",
        ]);
        
        const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\r\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `pocket-money-transactions_${new Date().toISOString().split("T")[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage("Transactions exported successfully!", "success");
      }

      // Handle form submission
      function handleTransaction(e) {
        e.preventDefault();
        if (!validateForm()) return;

        const transactionData = {
          id: transactionIdInput.value || generateID(),
          description: descriptionInput.value.trim(),
          amount: typeInput.value === "income" ? Math.abs(parseFloat(amountInput.value)) : -Math.abs(parseFloat(amountInput.value)),
          type: typeInput.value,
          category: typeInput.value === "expense" ? categoryInput.value : null,
          date: dateInput.value,
          recurring: recurringInput.value || "none",
        };

        if (transactionIdInput.value) {
          const idx = transactions.findIndex(t => t.id === transactionIdInput.value);
          if (idx > -1) transactions[idx] = transactionData;
          showMessage("Transaction updated successfully!", "success");
        } else {
          transactions.push(transactionData);
          showMessage("Transaction added successfully!", "success");
        }

        resetForm();
        updateUI();
      }

      // Reset form
      function resetForm() {
        form.reset();
        transactionIdInput.value = "";
        formTitle.textContent = "Add / Edit Transaction";
        submitBtn.textContent = "Add Transaction";
        cancelEditBtn.classList.add("hidden");
        dateInput.valueAsDate = new Date();
        dateInput.max = new Date().toISOString().split("T")[0];
        toggleCategory();
        clearValidationErrors();
      }

      // Toggle category visibility
      function toggleCategory() {
        categoryWrapper.style.display = typeInput.value === "expense" ? "block" : "none";
      }

      // Edit transaction
      function editTransaction(id) {
        const t = transactions.find(tr => tr.id === id);
        if (!t) return;

        transactionIdInput.value = t.id;
        descriptionInput.value = t.description;
        amountInput.value = Math.abs(t.amount).toFixed(2);
        typeInput.value = t.type;
        categoryInput.value = t.category || "Food";
        dateInput.value = t.date || "";
        recurringInput.value = t.recurring || "none";

        formTitle.textContent = "Edit Transaction";
        submitBtn.textContent = "Update Transaction";
        cancelEditBtn.classList.remove("hidden");
        toggleCategory();

        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Delete single transaction
      function deleteTransaction(id) {
        if (!confirm("Are you sure you want to delete this transaction?")) return;
        transactions = transactions.filter(t => t.id !== id);
        // Remove from selection if it was selected
        selectedTransactions.delete(id);
        showMessage("Transaction deleted successfully!", "success");
        updateUI();
      }

      // Update UI
      function updateUI() {
        handleRecurring();
        updateSummary();
        updateBudgetUI();
        filterAndRender();
        updateChart();
        saveTransactions();
      }

      // Initialize
      function init() {
        loadTheme();
        toggleCategory();
        updateUI();

        // Setup new refresh/reset functionality
        setupNewTaskMenu();
        setupQuickRefreshBtn();
        setupRefreshShortcuts();
        setupMultipleDeleteEvents();

        // Event listeners
        form.addEventListener("submit", handleTransaction);
        cancelEditBtn.addEventListener("click", resetForm);
        typeInput.addEventListener("change", toggleCategory);
        filterCategoryEl.addEventListener("change", filterAndRender);
        filterDateEl.addEventListener("change", filterAndRender);
        searchInput.addEventListener("input", filterAndRender);
        exportBtn.addEventListener("click", exportTransactionsCSV);
        themeSwitcher.addEventListener("change", e => applyTheme(e.target.value));

        // Transaction list event delegation
        transactionListEl.addEventListener("click", e => {
          const target = e.target;
          const action = target.dataset.action;
          const id = target.dataset.id;
          if (!action || !id) return;
          if (action === "edit") editTransaction(id);
          else if (action === "delete") deleteTransaction(id);
        });

        // Quick buttons
        quickButtons.forEach(button => {
          button.addEventListener("click", () => {
            descriptionInput.value = button.dataset.desc || "";
            amountInput.value = button.dataset.amount || "";
            typeInput.value = button.dataset.type || "income";
            categoryInput.value = button.dataset.category || "Food";
            recurringInput.value = "none";
            dateInput.valueAsDate = new Date();
            toggleCategory();
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
        });
      }

      // Start the app
      if (document.readyState !== "loading") init();
      else document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>

</html>

