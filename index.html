<script>
  // Transaction Manager App Logic

  // Helper to parse and save transactions in localStorage
  function getTransactions() {
    return JSON.parse(localStorage.getItem('transactions') || '[]');
  }

  function saveTransactions(transactions) {
    localStorage.setItem('transactions', JSON.stringify(transactions));
  }

  // Current state variables
  let selectedTransactionIds = new Set();
  let editTransactionId = null;

  // Render Transactions List with filtering and search
  function renderTransactions() {
    const list = document.getElementById('transaction-list');
    const noTransElem = document.getElementById('no-transactions');
    const transactions = getTransactions();
    const filterDate = document.getElementById('filter-date').value;
    const filterCategory = document.getElementById('filter-category').value.toLowerCase();
    const searchTerm = document.getElementById('search-input').value.toLowerCase();

    list.innerHTML = '';

    // Filter transactions based on date, category, and search
    let filtered = transactions.filter(tx => {
      // Date filter
      if (filterDate !== 'all') {
        const txDate = new Date(tx.date);
        const now = new Date();
        if (filterDate === 'week') {
          const weekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
          if (txDate < weekAgo) return false;
        } else if (filterDate === 'month') {
          const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
          if (txDate < monthAgo) return false;
        }
      }
      // Category / type filter
      if (filterCategory !== 'all') {
        if (filterCategory === 'income' && tx.type !== 'income') return false;
        else if (filterCategory !== 'income' && tx.category.toLowerCase() !== filterCategory) return false;
      }
      // Search filter
      if (searchTerm.length > 0) {
        if (!tx.description.toLowerCase().includes(searchTerm)) return false;
      }
      return true;
    });

    if (filtered.length === 0) {
      noTransElem.style.display = 'block';
      updateTotals(filtered);
      updateSelection();
      return;
    }

    noTransElem.style.display = 'none';

    filtered.forEach((tx, index) => {
      const li = document.createElement('li');
      li.className = 'transaction-item';

      // Checkbox for multi-select
      const checked = selectedTransactionIds.has(index) ? 'checked' : '';
      li.innerHTML = `
        <input type="checkbox" class="transaction-checkbox" data-index="${index}" ${checked} />
        <div class="flex-grow pl-3">
          <strong>${tx.description}</strong> <small>(${new Date(tx.date).toLocaleDateString()})</small><br/>
          <small class="text-gray-400">${tx.category} - ${tx.recurring !== 'none' ? `Recurring: ${tx.recurring}` : ''}</small>
        </div>
        <div class="${tx.type === 'income' ? 'text-green-400' : 'text-red-400'} font-semibold text-right w-28">
          ${tx.type === 'income' ? '+' : '-'}₹${Number(tx.amount).toFixed(2)}
        </div>
        <button class="btn-secondary ml-2 edit-btn" data-index="${index}" style="height:32px; align-self:center; flex-shrink:0;">Edit</button>
      `;
      list.appendChild(li);
    });

    updateTotals(filtered);
    updateSelection();

    // Attach checkbox listeners
    document.querySelectorAll('.transaction-checkbox').forEach(chk => {
      chk.addEventListener('change', function() {
        const idx = Number(this.dataset.index);
        if (this.checked) selectedTransactionIds.add(idx);
        else selectedTransactionIds.delete(idx);
        updateSelection();
      });
    });

    // Attach edit button listeners
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const idx = Number(this.dataset.index);
        startEditTransaction(idx);
      });
    });
  }

  // Update selection info and multi-delete controls
  function updateSelection() {
    const controls = document.getElementById('multiple-delete-controls');
    const selectedCountElem = document.getElementById('selected-count');
    const selectedCount = selectedTransactionIds.size;

    if (selectedCount > 0) {
      controls.classList.add('active');
      selectedCountElem.textContent = selectedCount;
    } else {
      controls.classList.remove('active');
      selectedCountElem.textContent = 0;
    }

    // Update select-all checkbox in header
    const allCheckbox = document.getElementById('select-all-checkbox');
    const transactions = getTransactions();
    const visibleIndexes = Array.from(document.querySelectorAll('.transaction-checkbox')).map(chk => Number(chk.dataset.index));
    if (visibleIndexes.length && visibleIndexes.every(idx => selectedTransactionIds.has(idx))) {
      allCheckbox.checked = true;
      allCheckbox.indeterminate = false;
    } else if (visibleIndexes.some(idx => selectedTransactionIds.has(idx))) {
      allCheckbox.checked = false;
      allCheckbox.indeterminate = true;
    } else {
      allCheckbox.checked = false;
      allCheckbox.indeterminate = false;
    }
  }

  // Update totals for given transaction list or entire list
  function updateTotals(transactionList) {
    const transactions = transactionList || getTransactions();
    let income = 0, expense = 0;
    transactions.forEach(tx => {
      if (tx.type === 'income') income += Number(tx.amount);
      else expense += Number(tx.amount);
    });
    const balance = income - expense;
    document.getElementById('income').textContent = `₹${income.toFixed(2)}`;
    document.getElementById('expense').textContent = `₹${expense.toFixed(2)}`;
    document.getElementById('balance').textContent = `₹${balance.toFixed(2)}`;

    // Update Chart
    renderExpenseChart(transactions.filter(tx => tx.type === 'expense'));
  }

  // Clear form and reset editing state
  function resetForm() {
    const form = document.getElementById('transaction-form');
    form.reset();
    editTransactionId = null;
    document.getElementById('form-title').textContent = 'Add / Edit Transaction';
    document.getElementById('submit-btn').textContent = 'Add Transaction';
    document.getElementById('cancel-edit-btn').classList.add('hidden');
  }

  // Start editing a transaction
  function startEditTransaction(idx) {
    const transactions = getTransactions();
    const tx = transactions[idx];
    if (!tx) return;

    document.getElementById('transaction-id').value = idx;
    document.getElementById('description').value = tx.description;
    document.getElementById('amount').value = tx.amount;
    document.getElementById('date').value = tx.date;
    document.getElementById('type').value = tx.type;
    document.getElementById('category').value = tx.category || 'Other';
    document.getElementById('recurring').value = tx.recurring || 'none';

    editTransactionId = idx;
    document.getElementById('form-title').textContent = 'Edit Transaction';
    document.getElementById('submit-btn').textContent = 'Save Changes';
    document.getElementById('cancel-edit-btn').classList.remove('hidden');
  }

  // Delete selected transactions
  function deleteSelected() {
    if (!confirm('Delete selected transactions? This cannot be undone.')) return;
    let transactions = getTransactions();
    // Convert set to sorted array descending to avoid index shift removal problem
    const indexesToRemove = Array.from(selectedTransactionIds).sort((a,b) => b - a);
    indexesToRemove.forEach(idx => {
      if (idx >= 0 && idx < transactions.length) {
        transactions.splice(idx, 1);
      }
    });
    selectedTransactionIds.clear();
    saveTransactions(transactions);
    renderTransactions();
  }

  // Select all visible transactions
  function selectAllVisible() {
    selectedTransactionIds.clear();
    document.querySelectorAll('.transaction-checkbox').forEach(chk => {
      chk.checked = true;
      selectedTransactionIds.add(Number(chk.dataset.index));
    });
    updateSelection();
  }

  // Deselect all
  function deselectAll() {
    selectedTransactionIds.clear();
    document.querySelectorAll('.transaction-checkbox').forEach(chk => chk.checked = false);
    updateSelection();
  }

  // Tab switching logic
  function initTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
        tab.classList.add('tab-active');

        // Show matching content section, hide others
        const targetId = 'content-' + tab.id.split('tab-')[1];
        document.querySelectorAll('.tab-content').forEach(content => {
          content.id === targetId ? content.classList.add('tab-content-active') : content.classList.remove('tab-content-active');
        });
      });
    });
  }

  // Theme switching
  function initThemeSwitcher() {
    const themeSwitcher = document.getElementById('theme-switcher');
    const themes = {
      light: {
        '--bg-primary': '#1a1f2b',
        '--bg-card': 'rgba(255,255,255,0.05)',
        '--text-primary': '#f5f5f7',
        '--text-secondary': '#c0c0c5',
        '--accent-color': '#d4af37',
        '--accent-hover': '#b6912f',
        '--border-color': 'rgba(255,255,255,0.1)',
        '--income-color': '#4ade80',
        '--expense-color': '#ef4444'
      },
      dark: {
        '--bg-primary': '#0f1823',
        '--bg-card': 'rgba(255,255,255,0.1)',
        '--text-primary': '#e0e0e0',
        '--text-secondary': '#999999',
        '--accent-color': '#d4af37',
        '--accent-hover': '#b6912f',
        '--border-color': 'rgba(255,255,255,0.2)',
        '--income-color': '#22c55e',
        '--expense-color': '#ef4444'
      },
      mint: {
        '--bg-primary': '#1c3d3a',
        '--bg-card': 'rgba(223,240,233,0.15)',
        '--text-primary': '#daf3e0',
        '--text-secondary': '#a3c9b1',
        '--accent-color': '#47b881',
        '--accent-hover': '#379f62',
        '--border-color': 'rgba(223,240,233,0.31)',
        '--income-color': '#68d391',
        '--expense-color': '#f87171'
      },
      sunset: {
        '--bg-primary': '#321414',
        '--bg-card': 'rgba(255,229,229,0.06)',
        '--text-primary': '#ffe3e3',
        '--text-secondary': '#c78989',
        '--accent-color': '#e08133',
        '--accent-hover': '#bb6626',
        '--border-color': 'rgba(255,99,71,0.15)',
        '--income-color': '#4ade80',
        '--expense-color': '#f87171'
      },
      dynamic: {
        // Could implement dynamic cycling colors or system theme detection here
      }
    };

    themeSwitcher.addEventListener('change', () => {
      const selected = themeSwitcher.value;
      if (themes[selected]) {
        Object.entries(themes[selected]).forEach(([prop, val]) => {
          document.documentElement.style.setProperty(prop, val);
        });
      }
    });
  }

  // CSV export
  function exportCSV() {
    const transactions = getTransactions();
    if (transactions.length === 0) {
      alert('No transactions to export');
      return;
    }
    const headers = ['Description', 'Amount', 'Date', 'Type', 'Category', 'Recurring'];
    const rows = transactions.map(tx => [tx.description, tx.amount, tx.date, tx.type, tx.category || '', tx.recurring || '']);
    let csvContent = headers.join(',') + '\n' + rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'transactions.csv';
    a.click();
  }

  // CSV import
  function importCSV(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const lines = text.trim().split('\n');
      if (lines.length < 2) {
        alert('CSV file is empty or invalid.');
        return;
      }
      const [headerLine, ...rows] = lines;
      const headers = headerLine.split(',').map(h => h.replace(/"/g, '').toLowerCase());
      const expected = ['description', 'amount', 'date', 'type', 'category', 'recurring'];

      // Validate headers
      if (!expected.every(h => headers.includes(h))) {
        alert('Invalid CSV headers.');
        return;
      }

      const transactions = getTransactions();

      rows.forEach(row => {
        const values = row.split(',').map(v => v.replace(/"/g, ''));
        const tx = {};
        headers.forEach((h, i) => { tx[h] = values[i] || ''; });
        // Basic validation
        if (!tx.description || isNaN(parseFloat(tx.amount)) || !tx.date) return;
        transactions.push({
          description: tx.description,
          amount: parseFloat(tx.amount),
          date: tx.date,
          type: tx.type || 'expense',
          category: tx.category || 'Other',
          recurring: tx.recurring || 'none'
        });
      });

      saveTransactions(transactions);
      renderTransactions();
      alert('Import complete.');
    };
    reader.readAsText(file);
  }

  // JSON backup
  function backupJSON() {
    const transactions = getTransactions();
    if (transactions.length === 0) {
      alert('No transactions to backup');
      return;
    }
    const blob = new Blob([JSON.stringify(transactions, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'transactions_backup.json';
    a.click();
  }

  // JSON restore
  function restoreJSON(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        if (!Array.isArray(data)) throw new Error('Invalid JSON format');
        // Simple structure checking
        if (!data.every(tx => tx.description && 'amount' in tx && tx.date && tx.type)) {
          alert('JSON content invalid');
          return;
        }
        saveTransactions(data);
        renderTransactions();
        alert('Data restored successfully');
      } catch (err) {
        alert('Error parsing JSON file: ' + err.message);
      }
    };
    reader.readAsText(file);
  }

  // Expense pie chart rendering using Chart.js
  let expenseChart = null;
  function renderExpenseChart(expenses) {
    const ctx = document.getElementById('expense-chart').getContext('2d');
    if (expenseChart) {
      expenseChart.destroy();
    }
    const categories = {};
    expenses.forEach(exp => {
      categories[exp.category] = (categories[exp.category] || 0) + Number(exp.amount);
    });
    const labels = Object.keys(categories);
    const data = Object.values(categories);

    expenseChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: [
            '#ef4444', '#f97316', '#facc15', '#4ade80', '#22d3ee', '#818cf8', '#a855f7'
          ],
          hoverOffset: 20
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: 'white' }
          }
        }
      }
    });
  }

  // Event and DOM initialization
  function init() {
    // Initial render
    renderTransactions();

    // Tabs
    initTabs();

    // Theme switcher
    initThemeSwitcher();

    const form = document.getElementById('transaction-form');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const desc = document.getElementById('description').value.trim();
      const amt = parseFloat(document.getElementById('amount').value);
      const dt = document.getElementById('date').value;
      const type = document.getElementById('type').value;
      const category = document.getElementById('category').value;
      const recurring = document.getElementById('recurring').value;

      if (!desc) {
        alert('Please enter a description.');
        return;
      }
      if (isNaN(amt) || amt <= 0) {
        alert('Please enter a valid amount greater than zero.');
        return;
      }
      if (!dt) {
        alert('Please enter a date.');
        return;
      }

      let transactions = getTransactions();

      if (editTransactionId !== null) {
        // Edit
        transactions[editTransactionId] = { description: desc, amount: amt, date: dt, type, category, recurring };
        alert('Transaction updated.');
      } else {
        transactions.push({ description: desc, amount: amt, date: dt, type, category, recurring });
        alert('Transaction added.');
      }

      saveTransactions(transactions);
      renderTransactions();
      resetForm();
    });

    document.getElementById('cancel-edit-btn').addEventListener('click', () => {
      resetForm();
    });

    document.getElementById('delete-selected-btn').addEventListener('click', () => {
      deleteSelected();
    });

    document.getElementById('select-all-btn').addEventListener('click', () => {
      selectAllVisible();
    });

    document.getElementById('deselect-all-btn').addEventListener('click', () => {
      deselectAll();
    });

    document.getElementById('select-all-checkbox').addEventListener('change', function() {
      if (this.checked) selectAllVisible();
      else deselectAll();
    });

    document.getElementById('filter-date').addEventListener('change', renderTransactions);
    document.getElementById('filter-category').addEventListener('change', renderTransactions);
    document.getElementById('search-input').addEventListener('input', renderTransactions);

    // CSV import/export
    document.getElementById('import-csv-btn').addEventListener('click', () => {
      document.getElementById('csv-file-input').click();
    });
    document.getElementById('csv-file-input').addEventListener('change', (e) => {
      importCSV(e.target.files[0]);
      e.target.value = '';
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      exportCSV();
    });

    // JSON backup/restore
    document.getElementById('backup-data-btn').addEventListener('click', () => {
      backupJSON();
    });
    document.getElementById('backup-file-input').addEventListener('change', e => {
      restoreJSON(e.target.files[0]);
      e.target.value = '';
    });

    // Extra controls menu toggling
    const newTaskBtn = document.getElementById('new-task-btn');
    const newTaskMenu = document.getElementById('new-task-menu');
    newTaskBtn.addEventListener('click', () => {
      newTaskMenu.classList.toggle('hidden');
    });

    document.getElementById('soft-reset-btn').addEventListener('click', () => {
      localStorage.removeItem('transactions');
      location.reload();
    });

    document.getElementById('hard-refresh-btn').addEventListener('click', () => {
      localStorage.clear();
      location.reload(true);
    });

    document.getElementById('clear-all-btn').addEventListener('click', () => {
      if (confirm('Clear all transaction data? This cannot be undone.')) {
        localStorage.removeItem('transactions');
        renderTransactions();
        resetForm();
      }
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (e.key === 'R' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        resetForm();
      } else if (e.key === 'R' && e.shiftKey) {
        e.preventDefault();
        location.reload(true);
      } else if (e.key === 'Delete') {
        if (selectedTransactionIds.size > 0) {
          deleteSelected();
        }
      } else if (e.key.toLowerCase() === 'i' && e.ctrlKey) {
        e.preventDefault();
        document.getElementById('csv-file-input').click();
      }
    });
  }

  // Initialize on document ready
  document.addEventListener('DOMContentLoaded', init);
</script>
