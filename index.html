<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pocket Money Manager </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.27/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --bg-primary:#f3f4f6;--bg-card:#fff;--text-primary:#1f2937;
      --text-secondary:#4b5563;--text-header:#111827;--border-color:#d1d5db;
      --accent-color:#4f46e5;--accent-hover:#4338ca;--income-color:#22c55e;
      --expense-color:#ef4444;
    }
    [data-theme="dark"]{--bg-primary:#111827;--bg-card:#1f2937;--text-primary:#f9fafb;
      --text-secondary:#9ca3af;--text-header:#fff;--border-color:#4b5563;}
    [data-theme="mint"]{--bg-primary:#f0fdfa;--bg-card:#fff;--text-primary:#134e4a;
      --text-secondary:#115e59;--text-header:#0f766e;--border-color:#ccfbf1;
      --accent-color:#14b8a6;--accent-hover:#0d9488;--income-color:#16a34a;--expense-color:#dc2626;}
    [data-theme="sunset"]{--bg-primary:#fffbeb;--bg-card:#fff;--text-primary:#78350f;
      --text-secondary:#92400e;--text-header:#b45309;--border-color:#fef3c7;--accent-color:#f59e0b;
      --accent-hover:#d97706;--income-color:#16a34a;--expense-color:#dc2626;}
    [data-theme="dynamic"]{--bg-primary:linear-gradient(-45deg,#667eea,#764ba2,#23a6d5,#23d5ab);
      --bg-card:rgba(255,255,255,0.1);--text-primary:#fff;--text-secondary:#e5e7eb;--text-header:#fff;
      --border-color:rgba(255,255,255,0.2);--accent-color:#38bdf8;--accent-hover:#0ea5e9;
      --income-color:#4ade80;--expense-color:#f87171;}
    body{font-family:"Inter",sans-serif;background:var(--bg-primary);color:var(--text-primary);
      transition:background 2s,color .3s;margin:0;min-height:100vh;}
    body[data-theme="dynamic"]{background-size:400% 400%;animation:gradientAnimation 15s ease infinite;}
    @keyframes gradientAnimation{0%{background-position:0% 50%}50%{background-position:100% 50%}
      100%{background-position:0% 50%}}
    .card{background:var(--bg-card);border-radius:.75rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),
      0 2px 4px -2px rgba(0,0,0,.1);transition:all .3s;padding:1.5rem;}
    .btn-primary{background:var(--accent-color);color:#fff;border:none;cursor:pointer;
      font-weight:600;border-radius:.5rem;padding:.75rem 1rem;width:100%;transition:background .3s;}
    .btn-primary:hover{background:var(--accent-hover)}
    .btn-secondary{background:var(--border-color);color:var(--text-primary);border:none;cursor:pointer;
      font-weight:600;border-radius:.5rem;padding:.75rem 1rem;width:100%;transition:opacity .3s;}
    .btn-secondary:hover{opacity:.9}
    .btn-danger{background:var(--expense-color);color:#fff;border:none;cursor:pointer;
      font-weight:600;border-radius:.5rem;padding:.75rem 1rem;width:100%;transition:background .3s;}
    .btn-danger:hover{background:#dc2626}
    .form-input{border-radius:.5rem;border:1px solid var(--border-color);padding:.75rem 1rem;
      width:100%;background:var(--bg-card);color:var(--text-primary);transition:border .3s;font-size:1rem;}
    .form-input:focus{border-color:var(--accent-color);outline:none;box-shadow:0 0 3px var(--accent-color);}
    .tab{cursor:pointer;padding:.5rem 1rem} .tab-active{border-bottom:2px solid var(--accent-color);font-weight:600}
    .tab-content{display:none}.tab-content-active{display:block}
    .transaction-item{border:1px solid var(--border-color);border-radius:.5rem;padding:1rem;
      display:flex;justify-content:space-between;align-items:center;transition:background .2s;}
    .transaction-item:hover{background:var(--bg-primary)}
    .transaction-item.selected{border-color:var(--accent-color);background:rgba(79,70,229,.1)}
    .transaction-checkbox,.select-all-checkbox{width:1.25rem;height:1.25rem;accent-color:var(--accent-color);}
    .multiple-delete-controls{display:none;background:var(--bg-card);border:1px solid var(--border-color);
      border-radius:.5rem;padding:1rem;margin-bottom:1rem;align-items:center;justify-content:space-between}
    .multiple-delete-controls.active{display:flex}
    .refresh-icon-btn{padding:.5rem .75rem;font-size:1.2rem}
    .new-task-menu{position:absolute;right:0;top:100%;margin-top:.5rem;width:200px;z-index:50;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}
    .new-task-menu button{width:100%;text-align:left;margin-bottom:.5rem;font-size:.875rem}
  </style>
</head>
<body data-theme="light">
  <div class="container mx-auto p-4 md:p-8 max-w-6xl">
    <header class="relative text-center mb-8">
      <h1 class="font-bold text-3xl md:text-4xl text-gray-900">Pocket Money Manager - Ultimate</h1>
      <p class="text-gray-600 mt-2">All features: tracking, analytics, budgets, goals, AI automation.</p>
      <!-- Tabs -->
      <div class="flex justify-center space-x-6 border-b mt-4">
        <div id="tab-transactions" class="tab tab-active">Transactions</div>
        <div id="tab-dashboard"     class="tab">Dashboard</div>
        <div id="tab-budget"        class="tab">Budget</div>
        <div id="tab-goals"         class="tab">Goals</div>
        <div id="tab-insights"      class="tab">Insights</div>
      </div>
      <!-- Utilities -->
      <div class="absolute top-0 right-0 flex items-center gap-2">
        <select id="theme-switcher" class="form-input rounded-md p-2" style="width:auto;">
          <option value="light">Light</option><option value="dark">Dark</option>
          <option value="mint">Mint</option><option value="sunset">Sunset</option>
          <option value="dynamic">Dynamic</option>
        </select>
        <button id="refresh-icon-btn" class="btn-secondary refresh-icon-btn">‚Üª</button>
        <div class="relative">
          <button id="new-task-btn" class="btn-secondary">New Task ‚ñæ</button>
          <div id="new-task-menu" class="new-task-menu card p-3 hidden">
            <button id="soft-reset-btn"      class="btn-secondary">üîÑ Soft Reset UI</button>
            <button id="hard-refresh-btn"    class="btn-secondary">‚ü≥ Hard Refresh Page</button>
            <button id="clear-all-btn"       class="btn-primary">üóëÔ∏è Clear All Data</button>
          </div>
        </div>
      </div>
      <div class="text-xs text-gray-500 mt-2">
        Shortcuts: <kbd>R</kbd> Reset, <kbd>Shift+R</kbd> Reload, <kbd>Del</kbd> Delete Selected, <kbd>Ctrl+I</kbd> Import CSV
      </div>
    </header>

    <!-- Transactions Tab -->
    <div id="content-transactions" class="tab-content tab-content-active">
      <!-- Multiple Delete Controls -->
      <div id="multiple-delete-controls" class="multiple-delete-controls">
        <div><span id="selected-count">0</span> selected</div>
        <div class="flex gap-2">
          <button id="select-all-btn" class="btn-secondary">Select All</button>
          <button id="deselect-all-btn" class="btn-secondary">Deselect All</button>
          <button id="delete-selected-btn" class="btn-danger">Delete Selected</button>
        </div>
      </div>
      <div class="flex items-center mb-3">
        <input type="checkbox" id="select-all-checkbox" class="select-all-checkbox"/>
        <label for="select-all-checkbox" class="ml-2 text-sm">Select All</label>
      </div>
      <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="card flex flex-col items-center">
          <h2 class="font-semibold text-gray-600">Total Balance</h2>
          <p id="balance"   class="text-indigo-600 font-bold text-3xl mt-2">‚Çπ0.00</p>
        </div>
        <div class="card flex flex-col items-center">
          <h2 class="font-semibold text-gray-600">Total Income</h2>
          <p id="income"    class="text-green font-bold text-3xl mt-2">‚Çπ0.00</p>
        </div>
        <div class="card flex flex-col items-center">
          <h2 class="font-semibold text-gray-600">Total Expense</h2>
          <p id="expense"   class="text-red font-bold text-3xl mt-2">‚Çπ0.00</p>
        </div>
      </section>
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <div class="lg:col-span-2">
          <div class="card p-6">
            <h2 id="form-title" class="text-2xl font-bold mb-4">Add / Edit Transaction</h2>
            <div class="flex flex-wrap gap-2 mb-4 quick-buttons"></div>
            <form id="transaction-form" novalidate>
              <input type="hidden" id="transaction-id"/>
              <div class="mb-4"><label>Description</label>
                <input id="description" class="form-input" required/>
                <p id="desc-error" class="error-msg" hidden></p>
              </div>
              <div class="mb-4"><label>Amount</label>
                <input id="amount" type="number" class="form-input" required min="0.01" step="0.01"/>
                <p id="amount-error" class="error-msg" hidden></p>
              </div>
              <div class="mb-4"><label>Date</label>
                <input id="date" type="date" class="form-input" required/>
                <p id="date-error" class="error-msg" hidden></p>
              </div>
              <div class="mb-4"><label>Type</label>
                <select id="type" class="form-input"><option value="income">Income</option><option value="expense">Expense</option></select>
              </div>
              <div class="mb-4" id="category-wrapper"><label>Category</label>
                <select id="category" class="form-input">
                  <option>Food</option><option>Travel</option><option>Entertainment</option>
                  <option>Bills</option><option>Other</option>
                </select>
              </div>
              <div class="mb-4"><label>Recurring</label>
                <select id="recurring" class="form-input"><option value="none">None</option>
                  <option value="daily">Daily</option><option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
              <div class="flex gap-4 mb-4">
                <button type="submit" id="submit-btn" class="btn-primary">Add Transaction</button>
                <button type="button" id="cancel-edit-btn" class="btn-secondary hidden">Cancel</button>
              </div>
            </form>
            <div class="flex gap-2">
              <button id="import-csv-btn" class="btn-secondary">Import CSV</button>
              <input type="file" id="csv-file-input" accept=".csv" class="hidden"/>
              <button id="backup-data-btn" class="btn-secondary">Download Backup</button>
              <input type="file" id="backup-file-input" accept="application/json" class="hidden"/>
              <button id="export-btn" class="btn-secondary">Export CSV</button>
            </div>
          </div>
        </div>
        <div class="lg:col-span-3 card p-6">
          <h2 class="text-2xl font-bold mb-4">Expense Breakdown</h2>
          <canvas id="expense-chart" style="max-height:300px;"></canvas>
        </div>
      </div>
      <div class="card p-6">
        <div class="flex justify-between mb-4 items-center">
          <h2 class="text-2xl font-bold">Transaction History</h2>
          <div class="flex gap-2">
            <select id="filter-date" class="form-input"><option value="all">All Time</option>
              <option value="week">This Week</option><option value="month">This Month</option>
            </select>
            <select id="filter-category" class="form-input"><option value="all">All Categories</option>
              <option value="income">Income</option><option>Food</option><option>Travel</option>
              <option>Entertainment</option><option>Bills</option><option>Other</option>
            </select>
            <input id="search-input" type="search" class="form-input" placeholder="Search..."/>
          </div>
        </div>
        <ul id="transaction-list" class="space-y-3">
          <li id="no-transactions" class="text-center text-gray-600 py-4">No transactions yet.</li>
        </ul>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="content-dashboard" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="card p-6">
          <h2 class="font-bold text-xl mb-4">Monthly Income vs Expense</h2>
          <canvas id="trend-chart" height="300"></canvas>
        </div>
        <div class="card p-6">
          <h2 class="font-bold text-xl mb-4">Category Spending Over Time</h2>
          <canvas id="category-chart" height="300"></canvas>
        </div>
      </div>
    </div>

    <!-- Budget Tab -->
    <div id="content-budget" class="tab-content p-6">
      <div class="flex justify-between mb-4">
        <h2 class="text-2xl font-bold">Budget Goals</h2>
        <button id="budget-settings-btn" class="btn-secondary w-auto">‚öôÔ∏è Budget Settings</button>
      </div>
      <div id="budget-container"></div>
      <!-- Budget Settings Modal -->
      <div id="budget-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <h3 class="text-xl font-semibold mb-4">Budget Settings</h3>
          <form id="budget-settings-form" class="space-y-4">
            <div>
              <label>Period</label>
              <select id="budget-period-type" class="form-input w-full">
                <option value="monthly">Monthly</option>
                <option value="weekly">Weekly</option>
              </select>
            </div>
            <div>
              <label><input type="checkbox" id="budget-rollover"/> Enable Rollover</label>
            </div>
            <div id="budget-inputs"></div>
            <div class="flex justify-end gap-2">
              <button type="button" id="budget-cancel-btn" class="btn-secondary">Cancel</button>
              <button type="submit" class="btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Goals Tab -->
    <div id="content-goals" class="tab-content p-6">
      <div class="flex justify-between mb-4">
        <h2 class="text-2xl font-bold">Savings Goal</h2>
        <button id="goal-settings-btn" class="btn-secondary w-auto">Set Goal</button>
        <button id="export-pdf-btn" class="btn-primary w-auto">Download PDF</button>
      </div>
      <div id="goal-tracker"></div>
      <!-- Goal Modal -->
      <div id="goal-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
          <h3 class="text-xl font-semibold mb-4">Set Savings Goal</h3>
          <form id="goal-form" class="space-y-4">
            <div>
              <label>Goal Amount</label>
              <input id="goal-amount" type="number" class="form-input w-full" min="0" step="0.01" required/>
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" id="goal-cancel-btn" class="btn-secondary">Cancel</button>
              <button type="submit" class="btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Insights Tab -->
    <div id="content-insights" class="tab-content p-6">
      <div class="card mb-6">
        <h2 class="font-bold text-xl mb-4">Smart Insights & Automation</h2>
        <div id="suggestions-panel" class="hidden bg-blue-50 p-3 rounded mb-4">
          <h3 class="text-blue-800 font-semibold">Category Suggestions</h3>
          <div id="suggestions-list"></div>
        </div>
        <div id="anomaly-panel" class="hidden bg-orange-50 p-3 rounded mb-4">
          <h3 class="text-orange-800 font-semibold">Unusual Spending Detected</h3>
          <div id="anomaly-list"></div>
        </div>
        <div id="prediction-panel" class="bg-green-50 p-3 rounded mb-4">
          <h3 class="text-green-800 font-semibold">Next Month Forecast</h3>
          <div id="prediction-content">Computing...</div>
        </div>
        <div id="reminders-panel" class="bg-purple-50 p-3 rounded">
          <h3 class="text-purple-800 font-semibold">Upcoming Bills</h3>
          <div id="reminders-list"></div>
          <button id="add-reminder-btn" class="btn-secondary mt-2 w-auto">Add Bill Reminder</button>
        </div>
      </div>
      <!-- Reminder Modal -->
      <div id="reminder-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
          <h3 class="text-xl font-semibold mb-4">Add Bill Reminder</h3>
          <form id="reminder-form" class="space-y-4">
            <div><label>Bill Name</label><input id="bill-name" class="form-input w-full" required/></div>
            <div><label>Amount</label><input id="bill-amount" type="number" class="form-input w-full" min="0" step="0.01" required/></div>
            <div><label>Due Day (1-31)</label><input id="bill-date" type="number" class="form-input w-full" min="1" max="31" required/></div>
            <div><label>Category</label>
              <select id="bill-category" class="form-input w-full">
                <option>Bills</option><option>Other</option>
              </select>
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" id="reminder-cancel-btn" class="btn-secondary">Cancel</button>
              <button type="submit" class="btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
  (()=>{"use strict";
    // Utility & state
    function formatAmount(v){const a=Math.abs(v);
      if(a>=1e12)return(v/1e12).toFixed(2)+"T";
      if(a>=1e9 )return(v/1e9).toFixed(2)+"B";
      if(a>=1e6 )return(v/1e6).toFixed(2)+"M";
      if(a>=1e3 )return(v/1e3).toFixed(2)+"K";
      return v.toFixed(2);
    }
    const tabs = {
      transactions:document.getElementById("tab-transactions"),
      dashboard:document.getElementById("tab-dashboard"),
      budget:document.getElementById("tab-budget"),
      goals:document.getElementById("tab-goals"),
      insights:document.getElementById("tab-insights")
    };
    const contents={
      transactions:document.getElementById("content-transactions"),
      dashboard:document.getElementById("content-dashboard"),
      budget:document.getElementById("content-budget"),
      goals:document.getElementById("content-goals"),
      insights:document.getElementById("content-insights")
    };
    Object.keys(tabs).forEach(k=>{
      tabs[k].onclick=()=>{Object.keys(tabs).forEach(m=>{
        tabs[m].classList.toggle("tab-active",m===k);
        contents[m].classList.toggle("tab-content-active",m===k);
      });
      if(k==="dashboard")renderDashboard();
      if(k==="budget")updateBudgetUI();
      if(k==="goals")renderSavingsGoal();
      if(k==="insights")initAI();
      };
    });

    // Global data
    let transactions=JSON.parse(localStorage.getItem("transactions"))||[],
        budgets=JSON.parse(localStorage.getItem("budgets"))||{values:{Food:3000,Travel:2000,Entertainment:1000,Bills:5000,Other:1000},periodType:"monthly",rollover:false},
        savingsGoal=JSON.parse(localStorage.getItem("savingsGoal"))||0,
        categoryPatterns=JSON.parse(localStorage.getItem("categoryPatterns"))||{},
        smartRules=JSON.parse(localStorage.getItem("smartRules"))||{},
        billReminders=JSON.parse(localStorage.getItem("billReminders"))||[];

    // Elements
    const balanceEl=document.getElementById("balance"), incomeEl=document.getElementById("income"),
      expenseEl=document.getElementById("expense"), transactionListEl=document.getElementById("transaction-list"),
      form=document.getElementById("transaction-form"),formTitle=document.getElementById("form-title"),
      descriptionInput=document.getElementById("description"),amountInput=document.getElementById("amount"),
      dateInput=document.getElementById("date"),typeInput=document.getElementById("type"),
      categoryWrapper=document.getElementById("category-wrapper"),categoryInput=document.getElementById("category"),
      transactionIdInput=document.getElementById("transaction-id"),recurringInput=document.getElementById("recurring"),
      submitBtn=document.getElementById("submit-btn"),cancelEditBtn=document.getElementById("cancel-edit-btn"),
      filterCategoryEl=document.getElementById("filter-category"),filterDateEl=document.getElementById("filter-date"),
      searchInput=document.getElementById("search-input"),noTransactionsEl=document.getElementById("no-transactions"),
      exportBtn=document.getElementById("export-btn"),budgetContainer=document.getElementById("budget-container"),
      chartCanvas=document.getElementById("expense-chart"),themeSwitcher=document.getElementById("theme-switcher"),
      quickButtonsContainer=document.querySelector(".quick-buttons"),
      // multiple delete
      multipleDeleteControls=document.getElementById("multiple-delete-controls"),
      selectedCountEl=document.getElementById("selected-count"),
      selectAllBtn=document.getElementById("select-all-btn"),
      deselectAllBtn=document.getElementById("deselect-all-btn"),
      deleteSelectedBtn=document.getElementById("delete-selected-btn"),
      selectAllCheckbox=document.getElementById("select-all-checkbox"),
      // Budget modal
      budgetSettingsBtn=document.getElementById("budget-settings-btn"),
      budgetModal=document.getElementById("budget-settings-modal"),
      budgetForm=document.getElementById("budget-settings-form"),
      periodSelect=document.getElementById("budget-period-type"),
      rolloverCheckbox=document.getElementById("budget-rollover"),
      budgetInputs=document.getElementById("budget-inputs"),
      budgetCancelBtn=document.getElementById("budget-cancel-btn"),
      // Goals
      goalSettingsBtn=document.getElementById("goal-settings-btn"),
      exportPdfBtn=document.getElementById("export-pdf-btn"),
      goalModal=document.getElementById("goal-modal"),
      goalForm=document.getElementById("goal-form"),
      goalAmountInput=document.getElementById("goal-amount"),
      goalCancelBtn=document.getElementById("goal-cancel-btn"),
      goalTracker=document.getElementById("goal-tracker"),
      // AI Insights
      suggestionsPanel=document.getElementById("suggestions-panel"),
      suggestionsList=document.getElementById("suggestions-list"),
      anomalyPanel=document.getElementById("anomaly-panel"),
      anomalyList=document.getElementById("anomaly-list"),
      predictionContent=document.getElementById("prediction-content"),
      remindersList=document.getElementById("reminders-list"),
      addReminderBtn=document.getElementById("add-reminder-btn"),
      reminderModal=document.getElementById("reminder-modal"),
      reminderForm=document.getElementById("reminder-form");

    // Validation errors
    const descError=document.getElementById("desc-error"),amountError=document.getElementById("amount-error"),
      dateError=document.getElementById("date-error");

    let expenseChart,selectedTransactions=new Set();

    // Utility functions
    const generateID=()=>"_"+Math.random().toString(36).substr(2,9);
    const saveTransactions=()=>localStorage.setItem("transactions",JSON.stringify(transactions));
    const saveBudgets=()=>localStorage.setItem("budgets",JSON.stringify(budgets));
    const clearErrors=()=>[descError,amountError,dateError].forEach(e=>{e.hidden=true;e.textContent=""});
    const showMessage=(t,type="info")=>{
      const m=document.createElement("div");
      m.className=`fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-all ${
        type==="success"?"bg-green-500":type==="error"?"bg-red-500":"bg-blue-500"
      }`;m.textContent=t;document.body.appendChild(m);
      setTimeout(()=>{m.classList.add("opacity-0","translate-x-full");setTimeout(()=>m.remove(),300)},2000);
    };

    // Index tabs on load
    document.addEventListener("DOMContentLoaded",()=>{
      init();if(tabs.dashboard.classList.contains("tab-active"))renderDashboard();
    });

    // Initialize app
    function init(){
      loadTheme();toggleCategory();updateUI();
      setupTabs();setupForm();setupMultipleDelete();setupNewTaskMenu();
      setupRefreshShortcuts();setupQuickRefresh();setupImportExport();
      setupBudgetSettings();setupGoalSettings();setupPDFExport();initAI();
      setupReminders();
    }

    // ---- Form & Transactions ----
    function validateForm(){
      clearErrors();let v=true;
      if(!descriptionInput.value.trim()){descError.textContent="Required";descError.hidden=false;v=false;}
      const amt=parseFloat(amountInput.value);
      if(isNaN(amt)||amt<0.01){amountError.textContent=">=0.01";amountError.hidden=false;v=false;}
      if(!dateInput.value){dateError.textContent="Required";dateError.hidden=false;v=false;}
      else if(new Date(dateInput.value)>new Date()){dateError.textContent="No future";dateError.hidden=false;v=false;}
      return v;
    }

    function setupForm(){
      // Quick buttons
      const templates=[
        {desc:"Salary",amount:50000,type:"income"},
        {desc:"Food",amount:500,type:"expense",category:"Food"},
        {desc:"Travel",amount:1000,type:"expense",category:"Travel"},
        {desc:"Entertainment",amount:700,type:"expense",category:"Entertainment"}
      ];
      templates.forEach(t=>{
        const b=document.createElement("button");
        b.textContent="Add "+t.desc;b.className="btn-primary text-xs";
        b.onclick=()=>{
          descriptionInput.value=t.desc;amountInput.value=t.amount;
          typeInput.value=t.type;categoryInput.value=t.category||"Food";
          recurringInput.value="none";dateInput.valueAsDate=new Date();
          toggleCategory();window.scrollTo({top:0,behavior:"smooth"});
        };
        quickButtonsContainer.appendChild(b);
      });

      form.onsubmit=e=>{e.preventDefault();if(!validateForm())return;
        const data={
          id:transactionIdInput.value||generateID(),
          description:descriptionInput.value.trim(),
          amount:typeInput.value==="income"?Math.abs(parseFloat(amountInput.value)):-Math.abs(parseFloat(amountInput.value)),
          type:typeInput.value,category:typeInput.value==="expense"?categoryInput.value:null,
          date:dateInput.value,recurring:recurringInput.value||"none"
        };
        if(transactionIdInput.value){
          const i=transactions.findIndex(t=>t.id===transactionIdInput.value);
          transactions[i]=data;showMessage("Updated","success");
        } else {transactions.push(data);showMessage("Added","success");}
        saveTransactions();resetForm();updateUI();initAI();
      };
      cancelEditBtn.onclick=resetForm;
    }

    function resetForm(){
      form.reset();transactionIdInput.value="";
      formTitle.textContent="Add / Edit Transaction";submitBtn.textContent="Add Transaction";
      cancelEditBtn.classList.add("hidden");dateInput.valueAsDate=new Date();toggleCategory();clearErrors();
    }

    function toggleCategory(){
      categoryWrapper.style.display=typeInput.value==="expense"?"block":"none";
    }

    function updateSummary(){
      const arr=transactions.map(t=>t.amount);
      const total=arr.reduce((a,b)=>a+b,0);
      const inc=arr.filter(a=>a>0).reduce((a,b)=>a+b,0);
      const exp=arr.filter(a=>a<0).reduce((a,b)=>a+b,0)*-1;
      balanceEl.textContent=`‚Çπ${formatAmount(total)}`;
      incomeEl.textContent=`‚Çπ${formatAmount(inc)}`;
      expenseEl.textContent=`‚Çπ${formatAmount(exp)}`;
    }

    function renderTransactions(list=transactions){
      transactionListEl.innerHTML="";
      if(list.length===0){transactionListEl.appendChild(noTransactionsEl);noTransactionsEl.style.display="block";return;}
      noTransactionsEl.style.display="none";
      list.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(t=>{
        const sign=t.type==="income"?"+":"-";
        const li=document.createElement("li");li.className="transaction-item";
        li.innerHTML=`
          <div class="flex items-center flex-1">
            <input type="checkbox" class="transaction-checkbox" data-id="${t.id}"/>
            <div class="flex-1">
              <p class="font-semibold text-gray-900">${t.description}</p>
              <p class="text-sm text-gray-600">${t.type==="expense"?t.category+",":""}
                <time>${new Date(t.date).toLocaleDateString()}</time>
                ${t.recurring!=="none"?` ‚Ä¢ Rec: ${t.recurring}`:""}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="${t.type==="income"?"text-green":"text-red"} font-bold">${sign}‚Çπ${formatAmount(Math.abs(t.amount))}</p>
            <div class="flex gap-2 mt-1">
              <button data-action="edit" data-id="${t.id}" class="text-xs text-indigo-600 hover:underline">Edit</button>
              <button data-action="delete" data-id="${t.id}" class="text-xs text-red-600 hover:underline">Delete</button>
            </div>
          </div>`;
        transactionListEl.appendChild(li);
      });
      document.querySelectorAll(".transaction-checkbox").forEach(ch=>{
        ch.onchange=e=>toggleTransactionSelection(e.target.dataset.id,e.target.checked);
      });
      updateTransactionItemStyles();updateMultipleDeleteControls();
    }

    function getFilteredTransactions(){
      let f=transactions;
      const df=filterDateEl.value,cf=filterCategoryEl.value,sr=searchInput.value.trim().toLowerCase();
      if(df==="week")f=f.filter(t=>isInCurrentWeek(t.date));
      else if(df==="month")f=f.filter(t=>isInCurrentMonth(t.date));
      if(cf!=="all"){if(cf==="income")f=f.filter(t=>t.type==="income");
      else f=f.filter(t=>t.type==="expense"&&t.category===cf);}
      if(sr)f=f.filter(t=>t.description.toLowerCase().includes(sr));
      return f;
    }
    function filterAndRender(){deselectAllTransactions();renderTransactions(getFilteredTransactions());}

    transactionListEl.onclick=e=>{
      const a=e.target.dataset.action,id=e.target.dataset.id;
      if(a==="edit")editTransaction(id);else if(a==="delete")deleteTransaction(id);
    };

    function editTransaction(id){
      const t=transactions.find(tr=>tr.id===id);if(!t) return;
      transactionIdInput.value=t.id;descriptionInput.value=t.description;
      amountInput.value=Math.abs(t.amount).toFixed(2);typeInput.value=t.type;
      categoryInput.value=t.category||"Food";dateInput.value=t.date;
      recurringInput.value=t.recurring||"none";formTitle.textContent="Edit Transaction";
      submitBtn.textContent="Update Transaction";cancelEditBtn.classList.remove("hidden");
      toggleCategory();window.scrollTo({top:0,behavior:"smooth"});
    }
    function deleteTransaction(id){
      if(!confirm("Delete?"))return;
      transactions=transactions.filter(t=>t.id!==id);selectedTransactions.delete(id);
      showMessage("Deleted","success");updateUI();
    }

    function updateUI(){
      handleRecurring();updateSummary();updateBudgetUI();
      renderTransactions();updateChart();renderSavingsGoal();
      initAI();showBillReminders();saveTransactions();saveBudgets();
    }

    // ---- Multiple Delete ----
    function setupMultipleDelete(){
      selectAllBtn.onclick=selectAllTransactions;
      deselectAllBtn.onclick=deselectAllTransactions;
      deleteSelectedBtn.onclick=deleteSelectedTransactions;
      selectAllCheckbox.onchange=e=>e.target.checked?selectAllTransactions():deselectAllTransactions();
      filterCategoryEl.onchange=filterAndRender;
      filterDateEl.onchange=filterAndRender;
      searchInput.oninput=filterAndRender;
    }
    function toggleTransactionSelection(id,sel){
      sel?selectedTransactions.add(id):selectedTransactions.delete(id);
      updateMultipleDeleteControls();updateTransactionItemStyles();
    }
    function selectAllTransactions(){
      getFilteredTransactions().forEach(t=>selectedTransactions.add(t.id));
      updateMultipleDeleteControls();updateTransactionItemStyles();
    }
    function deselectAllTransactions(){
      selectedTransactions.clear();updateMultipleDeleteControls();updateTransactionItemStyles();
    }
    function deleteSelectedTransactions(){
      const c=selectedTransactions.size;
      if(!c||!confirm(`Delete ${c}?`))return;
      transactions=transactions.filter(t=>!selectedTransactions.has(t.id));
      selectedTransactions.clear();showMessage(`${c} deleted`,"success");updateUI();
    }
    function updateMultipleDeleteControls(){
      const c=selectedTransactions.size;
      selectedCountEl.textContent=c;
      multipleDeleteControls.classList.toggle("active",c>0);
      const f=getFilteredTransactions();
      const allSel=f.length>0&&f.every(t=>selectedTransactions.has(t.id));
      const someSel=f.some(t=>selectedTransactions.has(t.id));
      selectAllCheckbox.checked=allSel;selectAllCheckbox.indeterminate=someSel&&!allSel;
    }
    function updateTransactionItemStyles(){
      document.querySelectorAll(".transaction-item").forEach(item=>{
        const cb=item.querySelector(".transaction-checkbox"),sel=cb&&selectedTransactions.has(cb.dataset.id);
        item.classList.toggle("selected",sel);if(cb)cb.checked=sel;
      });
    }

    // ---- Theming & Refresh ----
    function applyTheme(theme){
      document.body.dataset.theme=theme;localStorage.setItem("theme",theme);
      themeSwitcher.value=theme;updateChart();
    }
    function loadTheme(){applyTheme(localStorage.getItem("theme")||"light");}
    themeSwitcher.onchange=e=>applyTheme(e.target.value);

    function softResetUI(){
      resetForm();filterDateEl.value="all";filterCategoryEl.value="all";searchInput.value="";
      typeInput.value="income";toggleCategory();deselectAllTransactions();updateUI();
      showMessage("UI reset","success");
    }
    function hardRefresh(){location.reload();}
    function clearAllDataAndRefresh(){
      if(!confirm("Erase all?"))return;
      localStorage.clear();showMessage("Cleared","success");setTimeout(hardRefresh,500);
    }
    function setupNewTaskMenu(){
      const btn=document.getElementById("new-task-btn"),menu=document.getElementById("new-task-menu");
      btn.onclick=e=>{e.stopPropagation();const o=!menu.classList.contains("hidden");
        menu.classList.toggle("hidden",o);btn.setAttribute("aria-expanded",(!o).toString());
      };
      document.addEventListener("click",e=>{if(!menu.contains(e.target)&&e.target!==btn){
        menu.classList.add("hidden");btn.setAttribute("aria-expanded","false");
      }});
      document.getElementById("soft-reset-btn").onclick=softResetUI;
      document.getElementById("hard-refresh-btn").onclick=hardRefresh;
      document.getElementById("clear-all-btn").onclick=clearAllDataAndRefresh;
    }
    function setupQuickRefresh(){document.getElementById("refresh-icon-btn").onclick=softResetUI;}
    function setupRefreshShortcuts(){
      document.onkeydown=e=>{
        if(e.target.matches("input,textarea,select"))return;
        if(e.key.toLowerCase()==="r"){
          e.preventDefault();e.shiftKey?hardRefresh():softResetUI();
        } else if(e.key==="Delete")deleteSelectedTransactions();
        else if(e.ctrlKey&&e.key.toLowerCase()==="i"){
          e.preventDefault();document.getElementById("csv-file-input").click();
        }
      };
    }

    // ---- Dashboard ----
    function getMonthlyData(){
      const mths=[], labels=[];
      const now=new Date(),names=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      for(let i=11;i>=0;i--){
        const d=new Date(now.getFullYear(),now.getMonth()-i,1),key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        labels.push(`${names[d.getMonth()]} ${d.getFullYear()}`);mths.push(key);
      }
      const incD=[],expD=[];
      mths.forEach(k=>{
        let inc=0,exp=0;
        transactions.forEach(t=>{
          if(t.date.startsWith(k)){
            if(t.amount>0)inc+=t.amount;else exp+=-t.amount;
          }
        });
        incD.push(+inc.toFixed(2));expD.push(+exp.toFixed(2));
      });
      return{labels,incD,expD};
    }
    function getCategoryOverTime(){
      const now=new Date(),mths=[],labels=[];
      for(let i=5;i>=0;i--){
        const d=new Date(now.getFullYear(),now.getMonth()-i,1);
        mths.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`);
        labels.push(`${d.getMonth()+1}/${d.getFullYear()}`);
      }
      const sums={};
      transactions.forEach(t=>{
        if(t.type==="expense"){
          const m=t.date.slice(0,7);
          if(mths.includes(m)){
            sums[m]=sums[m]||{};
            sums[m][t.category]=(sums[m][t.category]||0)+Math.abs(t.amount);
          }
        }
      });
      const totalByCat={},cats=[];
      Object.values(sums).forEach(cmap=>Object.entries(cmap).forEach(([c,v]){totalByCat[c]=(totalByCat[c]||0)+v;}));
      cats=Object.entries(totalByCat).sort((a,b)=>b[1]-a[1]).slice(0,3).map(e=>e[0]);
      const colors=["#ef4444","#f59e0b","#84cc16"],datasets=cats.map((c,i)=>({
        label:c,data:mths.map(m=>+(sums[m]?.[c]||0).toFixed(2)),backgroundColor:colors[i],stack:"s"
      }));
      return{labels,datasets};
    }
    function renderDashboard(){
      const tctx=document.getElementById("trend-chart"),cctx=document.getElementById("category-chart");
      const d=getMonthlyData();
      new Chart(tctx,{type:"line",data:{labels:d.labels,datasets:[
        {label:"Income",data:d.incD,borderColor:"#22c55e",fill:false,tension:.3},
        {label:"Expense",data:d.expD,borderColor:"#ef4444",fill:false,tension:.3}
      ]},options:{responsive:true,plugins:{legend:{position:"top"}}}});
      const cat=getCategoryOverTime();
      new Chart(cctx,{type:"bar",data:{labels:cat.labels,datasets:cat.datasets},
        options:{responsive:true,plugins:{legend:{position:"top"}},scales:{x:{stacked:true},y:{stacked:true}}}});
    }

    // ---- Budget Settings ----
    function setupBudgetSettings(){
      budgetSettingsBtn.onclick=()=>{
        periodSelect.value=budgets.periodType;rolloverCheckbox.checked=budgets.rollover;
        budgetInputs.innerHTML="";
        Object.entries(budgets.values).forEach(([c,v])=>{
          budgetInputs.insertAdjacentHTML("beforeend",`
            <div class="mb-3">
              <label>${c} Budget</label>
              <input type="number" data-cat="${c}" class="form-input w-full" min="0" value="${v}"/>
            </div>`);
        });
        budgetModal.classList.remove("hidden");
      };
      budgetCancelBtn.onclick=()=>budgetModal.classList.add("hidden");
      budgetForm.onsubmit=e=>{
        e.preventDefault();
        const pt=periodSelect.value,ro=rolloverCheckbox.checked,nv={};
        budgetInputs.querySelectorAll("input[data-cat]").forEach(inp=>{
          nv[inp.dataset.cat]=parseFloat(inp.value)||0;
        });
        if(budgets.rollover&&pt===budgets.periodType){
          Object.entries(budgets.values).forEach(([c,oldB])=>{
            const spent=transactions.filter(t=>t.type==="expense"&&t.category===c&&isInCurrentPeriod(t.date,budgets.periodType))
              .reduce((s,t)=>s+Math.abs(t.amount),0);
            const left=oldB-spent;
            if(left>0)nv[c]=(nv[c]||0)+left;
          });
        }
        budgets={values:nv,periodType:pt,rollover:ro};
        saveBudgets();budgetModal.classList.add("hidden");updateBudgetUI();showMessage("Budgets saved","success");
      };
    }
    function isInCurrentPeriod(ds,pt){
      const d=new Date(ds),n=new Date();
      if(pt==="weekly"){const dow=n.getDay(),start=new Date(n);
        start.setDate(n.getDate()-dow);start.setHours(0,0,0,0);
        return d>=start&&d<=n;
      } else return d.getFullYear()===n.getFullYear()&&d.getMonth()===n.getMonth();
    }
    function updateBudgetUI(){
      budgetContainer.innerHTML="";
      const periodLabel=budgets.periodType==="weekly"?"Week":"Month";
      const totals={};
      transactions.forEach(t=>{
        if(t.type==="expense"&&isInCurrentPeriod(t.date,budgets.periodType))
          totals[t.category]=(totals[t.category]||0)+Math.abs(t.amount);
      });
      Object.entries(budgets.values).forEach(([c,b])=>{
        const spent=totals[c]||0,p=Math.min(100,(spent/b)*100),a80=p>=80&&p<100,a100=p>=100;
        budgetContainer.insertAdjacentHTML("beforeend",`
          <div class="mb-4">
            <div class="flex justify-between"><span>${c} (${periodLabel})</span><span>‚Çπ${formatAmount(spent)}/‚Çπ${formatAmount(b)}</span></div>
            <div class="progress-bar mb-1"><div class="progress-fill" style="width:${p}%;background-color:${a100?'var(--expense-color)':'var(--accent-color)'}"></div></div>
            ${a100?'<div class="alert">Exceeded!</div>':a80?'<div class="alert">Approaching!</div>':''}
          </div>`);
      });
    }

    // ---- Goals & PDF ----
    goalSettingsBtn.onclick=()=>{goalAmountInput.value=savingsGoal||"";goalModal.classList.remove("hidden");};
    goalCancelBtn.onclick=()=>goalModal.classList.add("hidden");
    goalForm.onsubmit=e=>{e.preventDefault();const v=parseFloat(goalAmountInput.value)||0;
      savingsGoal=v;localStorage.setItem("savingsGoal",JSON.stringify(v));goalModal.classList.add("hidden");
      renderSavingsGoal();showMessage("Goal saved","success");
    };
    function renderSavingsGoal(){
      if(!savingsGoal){goalTracker.innerHTML="<p>No goal set.</p>";return;}
      const arr=transactions.map(t=>t.amount),cur=arr.reduce((a,b)=>a+b,0),pct=Math.min(100,(cur/savingsGoal)*100);
      goalTracker.innerHTML=`
        <p>Goal: ‚Çπ${formatAmount(savingsGoal)}</p>
        <p>Saved: ‚Çπ${formatAmount(cur)}</p>
        <div class="progress-bar mb-1"><div class="progress-fill" style="width:${pct}%"></div></div>
        <p>${pct.toFixed(1)}% achieved</p>`;
    }
    exportPdfBtn.onclick=()=>{
      const {jsPDF}=window.jspdf;const doc=new jsPDF();
      const now=new Date().toLocaleString();
      doc.setFontSize(16).text("Pocket Money Report",14,20)
        .setFontSize(10).text(`Generated: ${now}`,14,28);
      const arr=transactions.map(t=>t.amount),tot=arr.reduce((a,b)=>a+b,0),inc=arr.filter(x=>x>0).reduce((a,b)=>a+b,0),
        exp=arr.filter(x=>x<0).reduce((a,b)=>a+b,0)*-1;
      doc.text(`Balance: ‚Çπ${formatAmount(tot)}`,14,36)
        .text(`Income: ‚Çπ${formatAmount(inc)}`,14,42)
        .text(`Expense: ‚Çπ${formatAmount(exp)}`,14,48);
      if(savingsGoal)doc.text(`Goal: ‚Çπ${formatAmount(savingsGoal)}`,14,54);
      const headers=[["Date","Desc","Type","Category","Amount"]];
      const rows=transactions.map(t=>[t.date,t.description,t.type,t.category||"-",formatAmount(t.amount)]);
      doc.autoTable({startY:60,head:headers,body:rows,theme:"grid",styles:{fontSize:8}});
      doc.save(`report_${new Date().toISOString().split("T")[0]}.pdf`);
    };

    // ---- Import/Export ----
    document.getElementById("import-csv-btn").onclick=()=>document.getElementById("csv-file-input").click();
    document.getElementById("csv-file-input").onchange=e=>{
      const file=e.target.files[0];if(!file)return;
      const r=new FileReader();r.onload=ev=>{
        try{
          const lines=ev.target.result.trim().split(/\r?\n/);
          const hdrs=lines.shift().split(",").map(h=>h.trim());
          const imp=lines.map(l=>{
            const cols=l.split(",");const o={};
            hdrs.forEach((h,i)=>o[h]=cols[i].replace(/^"|"$/g,""));
            return{id:generateID(),date:o.Date,description:o.Description,amount:parseFloat(o.Amount),
              type:o.Type,category:o.Category||null,recurring:o.Recurring||"none"};
          });
          transactions=transactions.concat(imp);saveTransactions();updateUI();showMessage(`Imported ${imp.length}`,"success");
        }catch(err){alert("CSV parse error");}
      };r.readAsText(file);e.target.value="";
    };
    document.getElementById("backup-data-btn").onclick=()=>{
      const data={transactions,budgets,theme:localStorage.getItem("theme"),savingsGoal,categoryPatterns,smartRules,billReminders};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}),url=URL.createObjectURL(blob);
      const a=document.createElement("a");a.href=url;a.download=`backup_${new Date().toISOString().split("T")[0]}.json`;
      document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);showMessage("Backup downloaded","success");
    };
    document.getElementById("backup-file-input").onchange=e=>{
      const file=e.target.files[0];if(!file)return;
      if(!confirm("Overwrite data?")){e.target.value="";return;}
      const r=new FileReader();r.onload=ev=>{
        try{
          const d=JSON.parse(ev.target.result);
          transactions=d.transactions||[];budgets=d.budgets||budgets;localStorage.setItem("theme",d.theme||"light");
          savingsGoal=d.savingsGoal||0;categoryPatterns=d.categoryPatterns||categoryPatterns;
          smartRules=d.smartRules||smartRules;billReminders=d.billReminders||billReminders;
          saveTransactions();saveBudgets();loadTheme();updateUI();showMessage("Restored backup","success");
        }catch(err){alert("Restore error");}
      };r.readAsText(file);e.target.value="";
    };

    // ---- Analytics ----
    function getMonthlyData(){
      const labels=[],mths=[];const now=new Date(),names=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      for(let i=11;i>=0;i--){
        const d=new Date(now.getFullYear(),now.getMonth()-i,1),key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        labels.push(`${names[d.getMonth()]} ${d.getFullYear()}`);mths.push(key);
      }
      const incD=[],expD=[];mths.forEach(k=>{let inc=0,exp=0;transactions.forEach(t=>{if(t.date.startsWith(k)){t.amount>0?inc+=t.amount:exp+=-t.amount;}});incD.push(+inc.toFixed(2));expD.push(+exp.toFixed(2));});
      return{labels,incD,expD};
    }
    function getCategoryOverTime(){
      const now=new Date(),labels=[],mths=[];for(let i=5;i>=0;i--){
        const d=new Date(now.getFullYear(),now.getMonth()-i,1);
        labels.push(`${d.getMonth()+1}/${d.getFullYear()}`);mths.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`);
      }
      const sums={};transactions.forEach(t=>{if(t.type==="expense"){const m=t.date.slice(0,7);if(mths.includes(m)){sums[m]=sums[m]||{};sums[m][t.category]=(sums[m][t.category]||0)+Math.abs(t.amount);}}});
      const totalByCat={},cats=[];Object.values(sums).forEach(obj=>Object.entries(obj).forEach(([c,v])=>totalByCat[c]=(totalByCat[c]||0)+v));
      cats=Object.entries(totalByCat).sort((a,b)=>b[1]-a[1]).slice(0,3).map(e=>e[0]);
      const colors=["#ef4444","#f59e0b","#84cc16"],datasets=cats.map((c,i)=>({label:c,data:mths.map(m=>+(sums[m]?.[c]||0).toFixed(2)),backgroundColor:colors[i],stack:"s"}));
      return{labels,datasets};
    }
    function renderDashboard(){
      const tctx=document.getElementById("trend-chart"),cctx=document.getElementById("category-chart");
      const md=getMonthlyData();
      new Chart(tctx,{type:"line",data:{labels:md.labels,datasets:[
        {label:"Income",data:md.incD,borderColor:"#22c55e",fill:false,tension:.3},
        {label:"Expense",data:md.expD,borderColor:"#ef4444",fill:false,tension:.3}
      ]},options:{responsive:true,plugins:{legend:{position:"top"}}}});
      const cat=getCategoryOverTime();
      new Chart(cctx,{type:"bar",data:{labels:cat.labels,datasets:cat.datasets},options:{responsive:true,plugins:{legend:{position:"top"}},scales:{x:{stacked:true},y:{stacked:true}}}});
    }

    // ---- AI Insights ----
    function learnCategoryPatterns(){
      transactions.forEach(t=>{if(t.type==="expense"&&t.category&&t.description){
        t.description.toLowerCase().split(/\s+/).forEach(w=>{if(w.length>2){
          categoryPatterns[w]=categoryPatterns[w]||{};categoryPatterns[w][t.category]=(categoryPatterns[w][t.category]||0)+1;
        }});
      }});
      localStorage.setItem("categoryPatterns",JSON.stringify(categoryPatterns));
    }
    function suggestCategory(desc){
      const scores={};desc.toLowerCase().split(/\s+/).forEach(w=>{if(categoryPatterns[w])Object.entries(categoryPatterns[w]).forEach(([c,n])=>scores[c]=(scores[c]||0)+n);});
      if(!Object.keys(scores).length)return null;
      const best=Object.entries(scores).sort((a,b)=>b[1]-a[1])[0];
      return best[1]>1?best[0]:null;
    }
    function showCategorySuggestions(){
      const u=transactions.filter(t=>t.type==="expense"&&(!t.category||t.category==="Other")).slice(0,5);
      const sug=u.map(t=>({t,s:suggestCategory(t.description)})).filter(x=>x.s);
      if(!sug.length){suggestionsPanel.classList.add("hidden");return;}
      suggestionsPanel.classList.remove("hidden");
      suggestionsList.innerHTML=sug.map(x=>`
        <div class="flex justify-between items-center mb-2 bg-white p-2 rounded">
          <span class="text-sm">"${x.t.description}" ‚Üí ${x.s}</span>
          <button class="btn-primary text-xs" onclick="applySuggestion('${x.t.id}','${x.s}')">Apply</button>
        </div>
      `).join("");
    }
    window.applySuggestion=(id,c)=>{const t=transactions.find(x=>x.id===id);if(t){t.category=c;saveTransactions();updateUI();showCategorySuggestions();showMessage("Categorized","success");}};

    function detectAnomalies(){
      const thisMonth=transactions.filter(t=>t.type==="expense"&&isInCurrentMonth(t.date));
      const byCat={};thisMonth.forEach(t=>byCat[t.category]=(byCat[t.category]||0)+Math.abs(t.amount));
      const anomalies=[];
      Object.entries(byCat).forEach(([c,sp])=>{const avg=getHistoricalAverage(c,3);
        if(avg>0&&sp>avg*1.5)anomalies.push({c,sp,avg,inc:((sp-avg)/avg*100).toFixed(0)});
      });
      if(!anomalies.length){anomalyPanel.classList.add("hidden");return;}
      anomalyPanel.classList.remove("hidden");
      anomalyList.innerHTML=anomalies.map(a=>`<div class="text-sm mb-1">${a.c}: ‚Çπ${formatAmount(a.sp)} (${a.inc}%>avg ‚Çπ${formatAmount(a.avg)})</div>`).join("");
    }
    function getHistoricalAverage(cat,m){
      const now=new Date();let tot=0,cnt=0;
      for(let i=1;i<=m;i++){
        const s=new Date(now.getFullYear(),now.getMonth()-i,1),e=new Date(now.getFullYear(),now.getMonth()-i+1,0);
        const ms=transactions.filter(t=>t.type==="expense"&&t.category===cat)
          .filter(t=>{const d=new Date(t.date);return d>=s&&d<=e;})
          .reduce((a,t)=>a+Math.abs(t.amount),0);
        if(ms>0){tot+=ms;cnt++;}
      }
      return cnt?tot/cnt:0;
    }
    function isInCurrentMonth(ds){
      const d=new Date(ds),n=new Date();
      return d.getFullYear()===n.getFullYear()&&d.getMonth()===n.getMonth();
    }

    function generatePredictions(){
      const pred={income:predictNextMonth("income"),expenses:predictExpensesByCategory(),savings:0};
      pred.savings=pred.income-Object.values(pred.expenses).reduce((a,b)=>a+b,0);
      predictionContent.innerHTML=`
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <p><strong>Income:</strong>‚Çπ${formatAmount(pred.income)}</p>
            <p><strong>Expenses:</strong>‚Çπ${formatAmount(Object.values(pred.expenses).reduce((a,b)=>a+b,0))}</p>
            <p><strong>Savings:</strong><span class="${pred.savings>=0?"text-green-600":"text-red-600"}">‚Çπ${formatAmount(pred.savings)}</span></p>
          </div>
          <div>
            <p><strong>Top 3:</strong></p>
            ${Object.entries(pred.expenses).slice(0,3).map(([c,a])=>`<p class="text-xs">${c}:‚Çπ${formatAmount(a)}</p>`).join("")}
          </div>
        </div>`;
    }
    function predictNextMonth(type){
      const arr=[];const now=new Date();
      for(let i=0;i<3;i++){
        const s=new Date(now.getFullYear(),now.getMonth()-i,1),e=new Date(now.getFullYear(),now.getMonth()-i+1,0);
        const m=transactions.filter(t=>t.type===type).filter(t=>{
          const d=new Date(t.date);return d>=s&&d<=e;
        }).reduce((a,t)=>a+(type==="income"?t.amount:Math.abs(t.amount)),0);
        arr.push(m);
      }
      return arr.reduce((a,b)=>a+b,0)/arr.length;
    }
    function predictExpensesByCategory(){
      return ["Food","Travel","Entertainment","Bills","Other"].reduce((acc,c)=>{acc[c]=getHistoricalAverage(c,3);return acc;},{});
    }

    function applySmartRules(){
      const d=new Date(),dom=d.getDate();
      Object.values(smartRules).forEach(r=>{
        if(r.enabled&&r.dayOfMonth===dom){
          const exists=transactions.some(t=>t.description===r.description&&t.date.startsWith(d.toISOString().slice(0,7)));
          if(!exists){
            transactions.push({id:generateID(),description:r.description,amount:r.type==="income"?r.amount:-r.amount,
              type:r.type,category:r.category,date:d.toISOString().slice(0,10),recurring:"monthly"});
            showMessage(`Auto-added ${r.description}`,"success");
          }
        }
      });
      saveTransactions();
    }
    setInterval(applySmartRules,24*60*60*1000);

    // ---- Bill Reminders ----
    addReminderBtn.onclick=()=>reminderModal.classList.remove("hidden");
    document.getElementById("reminder-cancel-btn").onclick=()=>reminderModal.classList.add("hidden");
    reminderForm.onsubmit=e=>{
      e.preventDefault();
      const r={id:generateID(),name:document.getElementById("bill-name").value,
        amount:parseFloat(document.getElementById("bill-amount").value),
        dayOfMonth:parseInt(document.getElementById("bill-date").value),
        category:document.getElementById("bill-category").value};
      billReminders.push(r);localStorage.setItem("billReminders",JSON.stringify(billReminders));
      reminderModal.classList.add("hidden");reminderForm.reset();showBillReminders();showMessage("Reminder added","success");
    };
    function showBillReminders(){
      const d=new Date(),list=billReminders.filter(r=>{const dl=r.dayOfMonth;return dl>=d.getDate()&&dl<=d.getDate()+7;});
      if(!list.length){remindersList.innerHTML="<p class='text-sm text-gray-600'>No upcoming bills.</p>";return;}
      remindersList.innerHTML=list.map(r=>`
        <div class="flex justify-between items-center mb-2 p-2 bg-white rounded">
          <div class="text-sm"><strong>${r.name}</strong> - ‚Çπ${formatAmount(r.amount)}
            <br><span class="text-xs text-gray-600">Due in ${r.dayOfMonth-new Date().getDate()} days</span>
          </div>
          <button class="btn-primary text-xs" onclick="payBill('${r.id}')">Mark Paid</button>
        </div>
      `).join("");
    }
    window.payBill=id=>{
      const r=billReminders.find(x=>x.id===id);
      if(r&&confirm(`Mark ${r.name} paid?`)){
        transactions.push({id:generateID(),description:r.name,amount:-r.amount,type:"expense",
          category:r.category,date:new Date().toISOString().slice(0,10),recurring:"none"});
        saveTransactions();updateUI();showMessage("Marked paid","success");
      }
    };

    // ---- CSV & Backup ----
    document.getElementById("import-csv-btn").onclick=()=>document.getElementById("csv-file-input").click();
    document.getElementById("csv-file-input").onchange=e=>{
      const f=e.target.files[0];if(!f)return;
      const r=new FileReader();r.onload=ev=>{
        try{
          const lines=ev.target.result.trim().split(/\r?\n/);
          const hdrs=lines.shift().split(",").map(h=>h.trim());
          const imp=lines.map(l=>{
            const cols=l.split(",");const o={};
            hdrs.forEach((h,i)=>o[h]=cols[i].replace(/^"|"$/g,""));
            return{id:generateID(),date:o.Date,description:o.Description,amount:parseFloat(o.Amount),
              type:o.Type,category:o.Category||null,recurring:o.Recurring||"none"};
          });
          transactions=transactions.concat(imp);saveTransactions();updateUI();showMessage(`Imported ${imp.length}`,"success");
        }catch{alert("CSV error");}
      };r.readAsText(f);e.target.value="";
    };
    document.getElementById("backup-data-btn").onclick=()=>{
      const data={transactions,budgets,theme:localStorage.getItem("theme"),savingsGoal,categoryPatterns,smartRules,billReminders};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}),url=URL.createObjectURL(blob);
      const a=document.createElement("a");a.href=url;a.download=`backup_${new Date().toISOString().split("T")[0]}.json`;
      document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);showMessage("Backup saved","success");
    };
    document.getElementById("backup-file-input").onchange=e=>{
      const f=e.target.files[0];if(!f)return; if(!confirm("Overwrite?")){e.target.value="";return;}
      const r=new FileReader();r.onload=ev=>{
        try{
          const d=JSON.parse(ev.target.result);
          transactions=d.transactions||[];budgets=d.budgets||budgets;localStorage.setItem("theme",d.theme||"light");
          savingsGoal=d.savingsGoal||0;categoryPatterns=d.categoryPatterns||categoryPatterns;
          smartRules=d.smartRules||smartRules;billReminders=d.billReminders||billReminders;
          saveTransactions();saveBudgets();loadTheme();updateUI();showMessage("Restored","success");
        }catch{alert("Restore error");}
      };r.readAsText(f);e.target.value="";
    };

    // ---- Recurring helper ----
    function handleRecurring(){
      const now=new Date(),next=[],dom=now.getDate();
      transactions.forEach(t=>{if(t.recurring!=="none"){
        const ld=new Date(t.date),nd=new Date(ld);
        if(t.recurring==="daily")nd.setDate(ld.getDate()+1);
        else if(t.recurring==="weekly")nd.setDate(ld.getDate()+7);
        else if(t.recurring==="monthly")nd.setMonth(ld.getMonth()+1);
        while(nd<=now){
          const exists=transactions.some(x=>x.description===t.description&&x.date===nd.toISOString().slice(0,10));
          if(!exists)next.push({...t,id:generateID(),date:nd.toISOString().slice(0,10)});
          if(t.recurring==="daily")nd.setDate(nd.getDate()+1);
          else if(t.recurring==="weekly")nd.setDate(nd.getDate()+7);
          else nd.setMonth(nd.getMonth()+1);
        }
      }});
      if(next.length){transactions=transactions.concat(next);saveTransactions();}
    }

    // -----------------------------------------
    // Initialization calls
    init();
  })();
  </script>
</body>
</html>
